% mnras_template.tex 
%
% LaTeX template for creating an MNRAS paper
%
% v3.0 released 14 May 2015
% (version numbers match those of mnras.cls)
%
% Copyright (C) Royal Astronomical Society 2015
% Authors:
% Keith T. Smith (Royal Astronomical Society)

% Change log
%
% v3.0 May 2015
%    Renamed to match the new package name
%    Version number matches mnras.cls
%    A few minor tweaks to wording
% v1.0 September 2013
%    Beta testing only - never publicly released
%    First version: a simple (ish) template for creating an MNRAS paper

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Basic setup. Most papers should leave these options alone.
\documentclass[fleqn,usenatbib]{mnras}

% MNRAS is set in Times font. If you don't have this installed (most LaTeX
% installations will be fine) or prefer the old Computer Modern fonts, comment
% out the following line
\usepackage{newtxtext,newtxmath}
% Depending on your LaTeX fonts installation, you might get better results with one of these:
%\usepackage{mathptmx}
%\usepackage{txfonts}

% Use vector fonts, so it zooms properly in on-screen viewing software
% Don't change these lines unless you know what you are doing
\usepackage[T1]{fontenc}

% Allow "Thomas van Noord" and "Simon de Laguarde" and alike to be sorted by "N" and "L" etc. in the bibliography.
% Write the name in the bibliography as "\VAN{Noord}{Van}{van} Noord, Thomas"
\DeclareRobustCommand{\VAN}[3]{#2}
\let\VANthebibliography\thebibliography
\def\thebibliography{\DeclareRobustCommand{\VAN}[3]{##3}\VANthebibliography}


%%%%% AUTHORS - PLACE YOUR OWN PACKAGES HERE %%%%%

% Only include extra packages if you really need them. Common packages are:
\usepackage{graphicx}	% Including figure files
% \usepackage{amsmath}	% Advanced maths commands
% \usepackage{amssymb}	% Extra maths symbols (this seems to be already defined)
\usepackage{cuted}
\setlength{\stripsep}{0ex}

\usepackage{tcolorbox}
\usepackage{listings}
%%
%% Julia definition (c) 2020 Daichi Furukawa
%%
\lstdefinelanguage{Julia}{%
  morekeywords={abstract, ans, baremodule, begin, break, const, continue, do,%
    elseif, else, end, export, finally, for, function, global, if, import,%
    let, local, macro, module, mutable, primitive, quote, return, struct, try,%
    type, using, var, where, while},%
  % Types
  morekeywords=[2]{Any, Array, Bool, BigInt, BigFloat, Char, DataType, Enum,%
    Expr, Float16, Float32, Float64, Function, Inf, Inf16, Inf32, Int8, Int16,%
    Int32, Int64, Int128, Matrix, Missing, Module, Nan, NaN16, NaN32, Nothing,%
    Some, Symbol, Tuple, Type, UInt8, UInt16, UInt32, UInt64, UInt128, Union,%
    UnionAll, Val, Vararg, Vector, VecOrMat, im},%
  % Constants
  morekeywords=[3]{ARGS, C_NULL, DEPOT_PATH, ENDIAN_BOM, ENV, LOAD_PATH,%
    PROGRAM_FILE, Sys.ARCH, Sys.BINDIR, Sys.CPU_THREADS, Sys.KERNEL,%
    Sys.MACHINE, Sys.WORD_SIZE, false, stderr, stdin, stdout, true, missing, nothing},%
  % Macros
  morekeywords=[4]{@NamedTuple, @allocated, @assert, @boundscheck, @deprecate,%
    @elapsed, @enum, @eval, @generated, @gensym, @goto, @isdefined, @inbouds,%
    @inline, @label, @noinline, @nospecialize, @polly, @propagate_inbounds,%
    @pure, @specialize, @simd, @time, @timed, @timev, @static, @v_str, @view,%
    @views},%
  sensitive=true,%
  morecomment=[l]\#,%
  morestring=[b]',%
  morestring=[b]",%
  morecomment=[s]{"""}{"""},% used for documentation text
                            % (mulitiline strings)
  morestring=[s]{r"}{"},% regular expression literal
  morestring=[s]{r"""}{"""},%
  morestring=[s]{raw"}{"},% raw string literals
  morestring=[s]{raw"""}{"""},%
  morestring=[s]{L"}{"},% LaTeX strings
  morestring=[s]{L"""}{"""}%
}%

\lstset{
    frame=single,
    % frameround=tttt,
    xleftmargin=2.4em,
    xrightmargin=1.3em,
    aboveskip=3mm,
    belowskip=1.0mm,
    backgroundcolor=\color{gray!3},
    showstringspaces=false,
    columns=flexible,
    basicstyle={\small\ttfamily},
    numbers=left,
    breaklines=true,
    breakatwhitespace=true,
    tabsize=4,
    keywordstyle = \bfseries\color{blue},
    stringstyle = \color{magenta},
    commentstyle = \color{green!70!black},
    language=Julia,
}

%%%%% AUTHORS - PLACE YOUR OWN COMMANDS HERE %%%%%

\input{custom-commands.tex}

%%%%%%%%%%%%%%%%%%% TITLE PAGE %%%%%%%%%%%%%%%%%%%

\title[Gradus.jl]{Gradus.jl: extensible and spacetime agnostic general relativistic ray-tracing for reverberation modelling through automatic differentiation}

% The list of authors, and the short list which is used in the headers.
% If you need two or more lines of authors, add an extra line using \newauthor
\author[F. J. E. Baker et al.]{
F. J. E. Baker,$^{1}$\thanks{E-mail: fergus.baker@bristol.ac.uk (FB)}
and A. J. Young$^{1}$
% Plus other contributing authors (tbc)
\\
% List of institutions
$^{1}$H. H. Wills Physics Laboratory, Tyndall Avenue, Bristol BS8 1TL, UK
}

% These dates will be filled out by the publisher
\date{Accepted XXX. Received YYY; in original form ZZZ}

% Enter the current year, for the copyright statements etc.
\pubyear{2023}

% Don't change these lines
\begin{document}
\label{firstpage}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}
\maketitle

% Abstract of the paper
\begin{abstract}
	We introduce \Gradus, an open-source...
\end{abstract}

% Select between one and six entries from the list of approved keywords.
% Don't make up new ones.
\begin{keywords}
keyword1 -- keyword2 -- keyword3
\end{keywords}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% BODY OF PAPER %%%%%%%%%%%%%%%%%%

%% INTRODUCTION
\input{gradus.introduction.tex}

%% NUMERICAL METHODS
\input{gradus.numerical-methods.tex}

\input{gradus.code.tex}

\section{Test problems}

\todo{explain why we compare those integrators}

\subsection{Integration accuracy and stability}

Since our method for integration does not use the constants of motion directly, the stability of the integrator may be gauged by sampling invariant quantities along the trajectory. In Figure \ref{fig:dot-stability} is shown the value the invariant of $v_\mu v^\mu$ for a geodesic that spirals into a maximally spinning black hole. The magnitude of the invariant is shown for a sample of integration algorithms, along with the solving time for the geodesic. Note this solving time includes the time to initialize the integrator, calculate the full trajectory (with interpolants), and package the solution structure. When tracing multiple geodesics, much of the initialization time may be avoided by reusing allocated memory -- see Section \ref{sec:performance}.

\begin{figure}
	\centering
	\includegraphics[width=0.95\linewidth]{figures/stability.conservation.pdf}
	\caption{\todo{caption + better choice of integrators to compare}}
	\label{fig:dot-stability}
\end{figure}

To test accuracy, we compare our numerical results with analytic values. The angular deflection is the difference in $x^\phi$ of a geodesic traveling from positive to negative infinity, that is
\begin{equation}
	\delta x^\phi :=
		x^\phi_{+\infty} - x^\phi_{-\infty} 
		- \pi,
\end{equation}
where the $-\pi$ is to account for radial change in the coordinate system between start and endpoint as the geodesic passes the origin \todo{is this right??}. Semi-analytic solutions for the deflection angle in the Kerr spacetime have been calculated for equatorial geodesics in \cite{iyer_lights_2009}, using elliptic integrals to find the coordinate differences. We follow their notation and denote the analytic deflection angle $\hat{\alpha}$, and present a compact summary of their calculations in Appendix \ref{appendix:deflection-angle}. 

Figure \ref{fig:deflection-angle} shows the deflection angle as a function of impact parameter $\alpha$ calculated using our code, along with the analytic deflection, and a measure of the error for different integration algorithms. Note the asymptotic behaviour of the error as $\lvert \alpha \rvert$ increases -- we account for this as related to the approximate observer at infinity in ray-tracing methods, catalyzed by the geometry of our observer introducing a small error at any finite $x^r$ when calculating the impact parameters relative to an $x^r = \infty$ observer. As can be expected, the error increases if $x^r_\text{start}$ is decreased.

\begin{figure}
	\centering
	\includegraphics[width=0.94\linewidth]{figures/deflection.iyer-hansen.pdf}
	\caption{Deflection angle in the Kerr spacetime ($M = 1$, $a = 0.998$) for geodesics in the equatorial plane over a range of impact parameters $\alpha$. Upper panel: numerical deflection $\delta x^r$ calculated with  $x^r_\text{start} = 2 \times 10^8 \, \rg$, absolute and relative tolerances set to $10^{-14}$, and effective infinity $4 \times 10^8\, \rg$, shown with the numerical solutions for $\hat{\alpha}$. Lower panel: the absolute relative error between the numeric and analytic deflection angles for different integration algorithms.}
	\label{fig:deflection-angle}
\end{figure}


\todo{Energy conservation, deflection problem, shadow, tests for naked-singularities}


\subsection{Emissivity curves}

We calculate a number of emissivity profiles that have been published in the literature as a test of the numerical methods in Section \ref{sec:emissivity-profiles}. In Figure \ref{fig:emissivity-profiles} are shown the emissivity profiles for the lamp post corona at different heights, including the time difference due to the Shapiro delay. Our results are consistent with other authors \citep{wilkins_understanding_2012,dauser_irradiation_2013}.

\begin{figure}
	\centering
	\includegraphics[width=0.99\linewidth]{figures/emissivity.point-source.pdf}
	\caption{\todo{caption}}
	\label{fig:emissivity-profiles}
\end{figure}

\todo{Wilkins and Fabian with lamp post and moving corona, gonzalez 2017}

\subsection{Line profiles}

Transfer functions are integrated as described in Section \ref{sec:transfer-function-integration}, neglecting the timing components. Figure \ref{fig:relline-comparison} compares the line profiles computed using the transfer functions of \Gradus and the \relline model of \cite{dauser_broad_2010}\footnote{We compare against the \relline model distributed in the Relxill package \url{http://www.sternwarte.uni-erlangen.de/~dauser/research/relxill/}, which is the latest version at time of publication (v2.3 with table v0.5a).}. We see good agreement to within $\sim 1\%$ accuracy, with all features collocated.

\begin{figure}
	\centering
	\includegraphics[width=0.99\linewidth]{figures/lineprofiles.comparison.pdf}
	\caption{Comparison of line profiles calculated by integrating transfer functions with emissivity $I_\text{em} = \varepsilon(r_\text{em}) = r_\text{em}^{-3}$ using \Gradus and \relline. The transfer functions are calculated for an observer at $r_\text{obs} = 1000\rg$ and $\theta_\text{obs} = 40^\circ$, and integrated between $r_\text{in} = r_\text{ISCO}$ and $r_\text{out} = 50 \rg$. Left panel is the the maximally spinning Kerr spacetime, whereas the right panel is the Schwarzschild spacetime.}
	\label{fig:relline-comparison}
\end{figure}

Our code permits a consistency check by binning geodesics on the image plane, with the appropriate weighting. This method may also be used to compute line profiles for accretion geometry that does not lend itself to the transfer function parameterization. In Figure \ref{fig:line-profile-ssd}, we compute a number of line profiles for the SSD, using both the binning and transfer integration approach. \todo{finish this section}

\begin{figure}
	\centering
	\includegraphics[width=0.99\linewidth]{figures/lineprofiles.ssd.pdf}
	\caption{Line profiles for the SSD with $\dot{M} / \dot{M}_\text{Edd} = 0.3$ for different observer inclinations $\theta_\text{obs}$ and emissivity $I_\text{em} = \varepsilon(r_\text{em}) = r_\text{em}^{-3}$. The transfer functions are calculated as in Figure \ref{fig:relline-comparison}, and integrated over the same limits. The light-grey lines correspond to the geometric thin disc ($\dot{M} / \dot{M}_\text{Edd} = 0$), and differ only for steep inclinations due to obscuration of inner $r_\text{em}$. Left panel is the the maximally spinning Kerr spacetime, whereas the right panel is the Schwarzschild spacetime.}
	\label{fig:line-profile-ssd}
\end{figure}


\subsection{Reverberation lags}
\label{sec:lag-transfer-functions}

\citep{reynolds_x-ray_1999,wilkins_origin_2013,cackett_modelling_2014}

\todo{Ingram's code? Jiachen's code}

\begin{figure}
	\centering
	\includegraphics[width=0.97\linewidth]{figures/transfer-functions.2d.pdf}
	\caption{\todo{caption + slit is the gap between upper and lower branch contributions:: idea, interpolate when in h or 1-h}}
	\label{fig:lag-frequency-transfer-functions}
\end{figure}

\subsubsection{Lag-frequency spectra}

Summing the two dimensional transfer functions over the energy axis for a given energy range yields an impulse response $\psi(t)$, describing the time evolution of the observed flux. This impulse response depends on the properties of the illuminating corona, accretion disc, spacetime, and inclination of the observer. Examples for different lamp post heights over the full energy range are shown in the top panel of Figure \ref{fig:reverberation-thin}.

Following \cite{cackett_modelling_2014}, we define the \textit{response fraction} $R$ as the ratio of reflected to continuum flux. The impulse response in the Fourier domain is then the rescaled Fourier transform
\begin{equation}
	\mathscr{F}_\psi(f) := R \int_{0}^\infty \psi(t) \e^{-2\pi i f t} \d t.
\end{equation}
The phase difference between the reflected and continuum flux is 
\begin{equation}
	\phi(f) = \tan^{-1} \left( 
		\frac{\Im{\mathscr{F}_\psi}}{1 + \Re{\mathscr{F}_\psi}} 
	\right),
\end{equation}
where $\Im{\mathscr{F}_\psi}$ and $\Re{\mathscr{F}_\psi}$ are the imaginary and real components of $\mathscr{F}_\psi$ respectively. The imaginary component represents the lag contribution to the phase difference. Since the driving signal is present in both bands, it adds no lag contribution, but serves to dilute the phase difference and therefore the real component of the signal through the $+1$ in the denominator \citep{cackett_modelling_2014}. \todo{expand on this}

The time lag is defined as 
\begin{equation}
	\tau(f) := \frac{\phi}{2 \pi f},
\end{equation}
and relates the observed time lag to the Fourier frequency of the driving signal (lower panel of Figure \ref{fig:reverberation-thin}).

\begin{figure}
	\centering
	\includegraphics[width=0.98\linewidth]{figures/reverberation.thin-disc.pdf}
	\caption{\todo{TODO + move legend}}
	\label{fig:reverberation-thin}
\end{figure}

We note a slight disagreement with \cite{cackett_modelling_2014} in the $h = 10$ and $h=20$ case, due to a weak-field approximation after $100\, \rg$, which the authors employ for performance. At $\theta_\text{obs} = 45^\circ$ inclination, the time difference due to the weak-field approximation between the reflected and continuum band increases with $h$, resulting in their continuum component arriving \textit{early}. This results in a shift of the impulse response towards later $t$, and therefore a greater low frequency lag and a shift of the peak of the negative lag to lower $f$ (see Appendix \ref{appendix:continuum-time} for more detail).
\todo{maybe put this in an appendix and explain better with figures??}

\subsubsection{Lag-energy spectra}

\begin{figure}
	\centering
	\includegraphics[width=0.98\linewidth]{figures/reverberation.lag-energy.pdf}
	\caption{\todo{TODO + move legend}}
	\label{fig:lag-energy}
\end{figure}


\subsection{Analytic radiative transfer model}

\cite{gold_verification_2020} specify an analytic model for testing radiative transfer codes (their Section 3.2, with results shown in their Figure 2 and 3). We have implemented their model and traced the radiative transfer problems with \Gradus, shown in Figure \ref{fig:gold-test-problems}. We find good agreement with the published results for all test problems.

\begin{figure*}
	\centering
	\includegraphics[width=0.99\linewidth]{figures/radiative-transfer.gold.pdf}
	\caption{Intensity images calculated with \Gradus of the radiative transfer analytic test models specified in \citet{gold_verification_2020} with resolution $128 \times 128$ pixels, and impact parameters ranging between $-15\, \rg$ and $15\, \rg$, and observer position $r_\text{obs} = 1000\, \rg$ and inclination $\theta_\text{obs} = 60^\circ$. The test cases correspond to the test parameters in their Table 1. The colouring is the intensity for the geodesic corresponding to that pixel normalized over the total intensity .}
	\label{fig:gold-test-problems}
\end{figure*}

\subsection{Other spacetimes}

Research into the appearance of compact singularities in modified gravity theories is often focused on the shadow of the singularity or the photon rings.

\cite{bambi_testing_2017,abdikamalov_testing_2020} have created a suite of codes \texttt{ABHModels}\footnote{\todo{add link}} for studying the iron line and reflection spectra from accreting black holes in the Johannsen metric. This metric is constructed by taking a higher order multipole expansion of the spherical harmonics of the metric \citep{johannsen_regular_2013}. Their codes are able to calculate lineprofiles and black-body disc spectra for the various deformation parameters of the Johannsen metric. Their code is however limited to a choice of a single deformation parameter, due to the method by which they construct their geodesic implementation. 

We compare the line profiles for the Johannsen metric in Figure \ref{fig:compare-johannsen}.

\todo{Bambi's various metrics and relline, self consistency between methods}
\todo{iron line profiles for Johannsen Psaltis}
\todo{geodesic motion of kerr newman}

\section{Applications}

\todo{working on spectral and timing models (Baker et al. in prep) for use in XSPEC and beyond}

\todo{working on propagating gradient information from models into spectral fitting pipelines}

\todo{including radiative transfer information in the transfer functions}

We are working on a optimized thick disc spectral and reverberation model for use in spectral fitting programs based on our thick disc transfer functions and time-dependant transfer function integration. 

\section{Conclusions}

We encourage the community to contact us with interesting problems that may be tackled using \Gradus as we are happy to assist with new applications of the code.

\todo{problems with the code are being patched, see github issues}

% Note future work, e.g., with regard to fitting, and using the code in other papers

\section*{Acknowledgements}
This work is supported by the UKRI AIMLAC CDT funded by grant EP/S023992/1.

We thank Jiachen Jiang, Cosimo Bambi and Askar Abdikamalov for sharing their software for comparisons. FB thanks Rosie for her expert debugging assistance, and Shaun for invaluable software discussions. All figures created using Makie.jl \citep{DanischKrumbiegel2021}, using the color scheme of \cite{wong_points_2011}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{Data Availability}

No new data or analyses have been created for this work. The code to reproduce this paper and all figures therein is freely available under MIT license:
\url{https://github.com/fjebaker/gradus-paper}


% The inclusion of a Data Availability Statement is a requirement for articles published in MNRAS. Data Availability Statements provide a standardised format for readers to understand the availability of data underlying the research results described in the article. The statement may refer to original data generated in the course of the study or to third-party data analysed in the article. The statement should describe and provide means of access, where possible, by linking to the data or providing the required accession numbers for the relevant databases or DOIs.

%%%%%%%%%%%%%%%%%%%% REFERENCES %%%%%%%%%%%%%%%%%%

% The best way to enter references is to use BibTeX:

\bibliographystyle{mnras}
\bibliography{citations} % if your bibtex file is called example.bib


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% APPENDICES %%%%%%%%%%%%%%%%%%%%%

\appendix

\input{gradus.appendix.gram-schmidt.tex}
\input{gradus.appendix.circular-orbits.tex}
\input{gradus.appendix.deflection-angle.tex}
\input{gradus.appendix.integrator-error.tex}
\input{gradus.appendix.continuum-time.tex}

% \section{Some extra material}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% Don't change these lines
\bsp	% typesetting comment
\label{lastpage}
\end{document}

% End of mnras_template.tex
