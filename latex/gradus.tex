% vim: cc=80 tw=80 wrap
% mnras_template.tex
%
% LaTeX template for creating an MNRAS paper
%
% v3.0 released 14 May 2015
% (version numbers match those of mnras.cls)
%
% Copyright (C) Royal Astronomical Society 2015
% Authors:
% Keith T. Smith (Royal Astronomical Society)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[fleqn,usenatbib]{mnras}
% MNRAS is set in Times font. If you don't have this installed (most LaTeX
% installations will be fine) or prefer the old Computer Modern fonts, comment
% out the following line

\usepackage{newtxtext,newtxmath}
% Use vector fonts, so it zooms properly in on-screen viewing software
% Don't change these lines unless you know what you are doing
\usepackage[T1]{fontenc}

% Allow "Thomas van Noord" and "Simon de Laguarde" and alike to be sorted by
% "N" and "L" etc. in the bibliography.  Write the name in the bibliography as
% "\VAN{Noord}{Van}{van} Noord, Thomas"
\DeclareRobustCommand{\VAN}[3]{#2}
\let\VANthebibliography\thebibliography
\def\thebibliography{\DeclareRobustCommand{\VAN}[3]{##3}\VANthebibliography}

%%%%% AUTHORS - PLACE YOUR OWN PACKAGES HERE %%%%%
\usepackage{graphicx}
% \usepackage{amsmath}
% \usepackage{amssymb}
\usepackage{cuted}
\setlength{\stripsep}{0ex}

\usepackage{tcolorbox}
\usepackage{listings}
\usepackage{xspace}

%%%%%%%%%%%% CUSTOM COMMANDS %%%%%%%%%%%%%%%%%%%%%

\newcommand{\citneeded}{{\bf \color{red} $^{\text{citation needed}}$}}
\newcommand{\todo}[1]{{\noindent \bf \color{red} TODO: #1}}
\newcommand{\revisit}[1]{{\color{cyan} #1}}
\newcommand{\notes}[1]{{\color{cyan} #1}}

\newcommand{\Gradus}{Gradus.jl\xspace}
\newcommand{\FeKa}{Fe K$\alpha$ }
\newcommand{\relline}{\texttt{relline} }

\newcommand{\e}{\text{e}}
\renewcommand{\d}{\text{d}}
\newcommand{\rg}{r_\text{g}}
\newcommand{\utensor}[3]{#1^{#2}_{\phantom{#2}#3}}
\newcommand{\dtensor}[3]{#1_{#2}^{\phantom{#2}#3}}
\newcommand{\stensor}[3]{#1_{#2}^{#3}}
\newcommand{\deriv}[2]{\frac{\d #1}{\d #2}}
\newcommand{\pderiv}[2]{\frac{\partial #1}{\partial #2}}
\newcommand{\risco}{r_\text{ISCO}}

\newcommand{\vel}[1]{v^{#1}}
\renewcommand{\vector}[1]{\mathbf{#1}}
\newcommand{\jacobian}[2]{\left\lvert \frac{\partial #1}{\partial #2} \right\rvert}

\renewcommand{\Im}[1]{\text{Im}\left[#1\right]}
\renewcommand{\Re}[1]{\text{Re}\left[#1\right]}

%%%%%%%%%%%%%%%%%%% TITLE PAGE %%%%%%%%%%%%%%%%%%%

% \title[Gradus.jl]{General relativistic ray-tracing and reverberation modelling through automatic differentiation with Gradus.jl}
\title[Gradus.jl]{Gradus.jl: spacetime-agnostic general relativistic ray-tracing
for X-ray spectral modelling}
\author[F. J. E. Baker et al.]{
F. J. E. Baker,$^{1}$\thanks{E-mail: fergus.baker@bristol.ac.uk (FB)}
and A. J. Young$^{1}$
\\
$^{1}$H. H. Wills Physics Laboratory, Tyndall Avenue, Bristol BS8 1TL, UK
}
% These dates will be filled out by the publisher
\date{Accepted XXX. Received YYY; in original form ZZZ}
% Enter the current year, for the copyright statements etc.
\pubyear{2023}

% Don't change these lines
\begin{document}
\label{firstpage}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}
\maketitle
% Abstract of the paper
\begin{abstract}
    We introduce \Gradus, an open-source...
\end{abstract}

% Select between one and six entries from the list of approved keywords.
%Don't make up new ones.
\begin{keywords}
accretion, accretion discs -- black hole physics -- gravitation -- line: profiles -- relativistic processes -- methods: numerical
\end{keywords}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% BODY OF PAPER %%%%%%%%%%%%%%%%%%

%%% INTRODUCTION %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}

General relativistic ray-tracing (GRRT) is a computational technique used in
spectral modelling that computes the trajectory of individuals photons through a
given spacetime. It enables the calculation of spectral components and radiative
processes in strong gravity around black holes, neutron stars, and other compact
objects, making the technique invaluable for models of the inner regions of the
accretion flow. The general relativistic (GR) effects cause significant
deviations from the classical results in the observed spectra
\citep[e.g.][]{cunningham_optical_1973, fabian_long_2002}, timing
\citep[e.g.][]{stella_measuring_1990, reynolds_x-ray_1999}, and appearance
\citep[e.g.][]{luminet_image_1979}. It is therefore crucially important that
such effects are included in spectral models of accretion onto compact objects.

GRRT has a long history in spectral modelling, with widespread use in modelling
reflection spectra \citep[e.g.][]{fabian_x-ray_1989}, accretion disc emissivity
due to the X-ray corona \citep[e.g.][]{wilkins_understanding_2012,
wilkins_towards_2016}, emission and absorption features
\citep[e.g.][]{ruszkowski_absorption_2002}, spectral energy densities of quasars
\citep[e.g.][]{hagen_estimating_2023}, variability such as reverberation lags or
propagating fluctuations
\citep[e.g.][]{ingram_public_2019}, the corona-disc connection in thermal lags
\citep[e.g.][]{kammoun_hard_2019}, quasi-periodic oscillations \citep[QPOs,
e.g.][]{tsang_iron_2013}, and so on.  We refer the reader to the reviews of
\citet{reynolds_iron_lines_2003} and \citet{reynolds_observational_2021} for
detailed discussion of relativistic X-ray spectroscopy, and
\citet{uttley_x-ray_2014} and \citet{cackett_reverberation_2021} for reviews of
X-ray reverberation, and the accompanying use of GRRT.

In the interest of computational performance, GRRT results are commonly
pre-computed for spectral models \citep{laor_line_1991}. For example, in
reflection spectra models, such as \texttt{relline} / \texttt{relxill}
\citep{dauser_broad_2010, dauser_relativistic_2016} or \texttt{kyn} \todo{cite
dovciak}, tabular GRRT data is integrated with an emissivity function to rapidly
compute the spectral components. A consequence of pre-computation is that only a
limited parameter domain can be sampled, and assumptions concerning, say, the
disc geometry or velocity structure become baked into the tabulated data. Many
GRRT models assume a razor-thin disc in the equatorial plane with strictly
Keplerian velocity structure \citep[e.g.][]{dovciak_extended_2004,
beckwith_iron_2004, brenneman_constraining_2006, dauser_broad_2010}. These
assumptions may differ from the rest-frame models they are convolved with when
used in concert with other models.

% The effects of other disc geometries and velocity structures have been explored
% for some specific cases: the models of \citet{karas_light_1992} and
% \citet{karas_vicinity_1992} examine the changing line profiles of hot spots
% eclipsed in thick discs, \citet{pariev_line_1998} study the effects of turbulent
% velocities in a Novikov-Thorne accretion discs,
% \citet{hartnoll_reprocessed_2001} model a warped accretion disc,
% \citet{fukumura_iron_2004} study a spiral velocity structure; a conical disc
% structure is explored by \citet{wu_iron_2007} including sub-Keplerian orbits and
% the effects of self-occulting of the disc, \citet{taylor_exploring_2018,
% taylor_x-ray_2018_reverb} calculate tabular line profile models and
% reverberation features for a disc with the Shakura-Sunyaev height profile,
% \citet{thomsen_relativistic_2022} model X-ray reverberation in super-Eddington
% accretion flows, and \citet{abdikamalov_testing_2020} study a Novikov-Thorne
% disc in the \citet{johannsen_regular_2013} spacetime.

There has recently been increased interest in ``tests of relativity'', studying
spacetime solutions that deviate from a Kerr black hole (e.g.
\citealt{johannsen_testing_2010, chrusciel_stationary_2012, bambi_testing_2022,
patra_accretion_2023, chen_observational_2024},). These include spacetimes that
violate the \textit{no-hair} uniqueness theorems\footnote{In \emph{no-hair}
theorems, `hair' is metaphor for additional information in the spacetime beyond
mass, angular momentum, and charge.}. The interest is in part driven by
observations made by the Event Horizon Telescope collaboration of the `shadow'
and photon ring of M87 and Mgr A*
\citep{the_event_horizon_telescope_collaboration_first_2019,
the_event_horizon_telescope_collaboration_first_2023}, as these have inspired a
wealth of study into different spacetimes \citep[see][]{eht_non_kerr_2022}.
There is similarly research dedicated to using disc spectra and line profiles to
measure deviations from the Kerr spacetime, yielding seemingly tight constraints
on the deformation parameters of some spacetime solutions
\citep[e.g.][]{bambi_precision_measuremets_2021}. To explore the use and
validity of X-ray spectroscopy in tests of relativity requires performant
spectral models, and in turn pre-computed GRRT tables for alternative
spacetimes.

For most relativistic spectral models, the pre-computed tabular data is a set of
\textit{transfer functions}, used to efficiently calculate line profiles or
convolution kernels. There are few immediately available public codes that can
reliably calculate new transfer function tables, even for the simplified
razor-thin Keplerian disc models, and none that the authors are aware of that
can reliably do so for other disc geometries, velocity structures, and
spacetimes. It is to address this gap that we present a new publicly available
GRRT code, Gradus.jl\footnote{Open-source and available under GPL 3.0 license at
\url{https://github.com/astro-group-bristol/Gradus.jl}.}. Written in the Julia
programming language \citep{Bezanson_Julia_A_fresh_2017}, our package is a
general toolkit for including relativistic effects in spectral models.  Models
created with \Gradus can be used in spectral fitting packages, such as XSPEC
\citep{arnaud_xspec_1996} or SpectralFitting.jl \citneeded.

% We maintain C-ABI
% compatible wrappers for integrating the transfer function tables that have
% similar capabilities as popular convolution models\footnote{We use the Zig
%     programming language \url{https://ziglang.org/} to wrap the spectral models.
%     This allows us to statically compile models for a wide variety of targets.
% Models can then be downloaded and imported into e.g. XSPEC without the need for
% any additional tools.}. \Gradus additionally allows for constructing custom
% convolution kernels within a component modelling framework that can be made to
% more closely match the assumptions made in their models with respect to, for
% example, accretion disc geometry, disc velocity structure, or corona.

The paper is organised as follows: in Section
\ref{sec:numerical-methods} we describe the numerical methods used in \Gradus,
introducing the techniques and algorithms of our code. This description
necessarily avoids implementation details, focusing on
the mathematical and algorithmic narrative, as the implementation is
publicly available and detailed in the \Gradus documentation. In Section
\ref{sec:description-of-code} the software is discussed to overview its
features. Section
\ref{sec:test-problems} assesses the validity of the code using a number of
tests and problems from existing literature, and compares results computed
with \Gradus to other published codes. This includes also new illustrative
simulation results that examine the effect of disc thickness on the X-ray
reverberation lag. Intended applications of and future work on \Gradus are
described in Section \ref{sec:applications}. Finally, overall conclusions are
given in Section \ref{sec:conclusion}.

%%% NUMERICAL METHODS %%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Numerical methods}
\label{sec:numerical-methods}

For simplicity, we focus on stationary, axisymmetric spacetimes in the
Boyer-Lindquist coordinates. Such spacetimes have metrics of the form
\begin{equation}
\label{eq:stationary_axisymmetric_metric}
    g_{\mu\nu}
    = g_{tt} \d t^2
    + g_{rr} \d r^2
    + g_{\theta\theta} \d \theta^2
    + g_{\phi\phi} \d \phi^2
    + 2g_{t\phi} \d t \d \phi.
\end{equation}
We adopt $(-, +, +, +)$ metric signature in our code, and standard units $c = G
= 1$. Greek indices ($\mu, \nu$) denote the four spacetime components, and Latin
indices ($i, j$) the three spatial components. We write partial derivatives with
respect to the coordinates $x^\mu$ as $\partial_\mu := \partial / \partial
x^\mu$.

\subsection{Geodesic integration}

The trajectory of particles in curved space is determined by integrating the
geodesic equation (\emph{tracing}) under the assumption that energy and angular
momentum are conserved. The integration may be formulated in a number of ways:
as a second-order set of ordinary differential equations (ODEs) directly,
analytically integrated once to give a set of first-order (ODEs), or
analytically integrated twice to give elliptical integrals. The second-order ODE
appraoch is conceptually the most simple and has the benefit that it gives the
position and velocity of the geodesic at each step of the integration.  The
formulation requires a specification of the metric and the metric connection
(Christoffel symbols). These are usually implemented by-hand and can lead to a
high degree of code complexity that scales poorly as the number of terms in the
metric increases. An alternative is to use a numeric differentiation scheme,
such as automatic differentiation (AD), to calculate the Jacobian of the metric
and Christoffel symbols \emph{on-the-fly}. This is the approach used in \Gradus,
and allows a new spacetime to be implemented with only an implementation of the
non-zero metric elements.

Using coordinates $x^\mu$, the geodesic equation with external acceleration
$a^\mu$ is written
\begin{equation}
\label{eq:geodesic_equation}
    \frac{\d^2 x^\mu}{\d \lambda^2}
    + \utensor{\Gamma}{\mu}{\nu\sigma}
    \vel{\nu}
    \vel{\sigma}
    = a^\mu,
\end{equation}
where $\lambda$ is an affine parameter and $v^\mu = \d x^\mu / \d \lambda$ is
the four-velocity. The effects of spacetime curvature on the trajectory are
encoded in the Christoffel symbols,
\begin{equation}
\label{eq:christoffel}
    \utensor{\Gamma}{\mu}{\nu\sigma}
    := \frac{1}{2} g^{\mu\rho}
    \left(
        \partial_{\nu}g_{\rho \sigma}
        + \partial_{\sigma}g_{\rho \nu}
        - \partial_{\rho}g_{\sigma \nu}
    \right).
\end{equation}
In the second-order ODE formulation, the geodesic equation is an initial value
problem with four coupled equations that can be
solved with a choice of initial $x^\mu$ and $\vel{\mu}$. We are free to to
choose an initial 3-position $x^i$ (with $x^t = 0$ by convention), and constrain
the velocity using the invariance
\begin{equation}
\label{eq:velocity_constraint}
    g_{\sigma\nu} \vel{\sigma} \vel{\nu} = \mu^2,
\end{equation}
where $\mu$ is the invariant mass. This constraint gives rise to three solution
classes depending on the sign of $\mu^2$; namely $\mu^2 = 0$ corresponding to
\emph{null geodesics}, $\mu^2 > 0$ to \emph{time-like geodesics}, and $\mu^2 <
0$ to \emph{space-like geodesics}. Null geodesics are the trajectories of
photons, time-like geodesics are the trajectories of massive particles, and
space-like geodesics are the trajectories of exotic ``faster-than-light''
particles (e.g. tachyons).

As with the position, it is sufficient to specify the three-vector $\vel{i}$,
and use \eqref{eq:velocity_constraint} to determine $\vel{t}$ by rearranging
\begin{equation}
\vel{t}  = \frac{-g_{t\phi} \vel{\phi} \pm
    \sqrt{-g_{ij} \vel{i} \vel{j} - \mu^2}
}{g_{tt}}.
\end{equation}
Sensible choices of $v^i$ will be discussed in the next section.

The choice of positive or negative root corresponds to the direction of time,
wherein lies the \textit{ray-tracing trick}: a time-reversal symmetry in the
metric $t \rightarrow -t$, $\phi \rightarrow -\phi$ allows us to calculate
geodesics in the forward direction as if they had travelled \textit{backwards}.
Photons can therefore be traced from an observer towards the black hole, and
calculations performed as if they had been emitted from near the black hole and
travelled towards the observer. This seemingly trivial point cannot be
understated in an implementation of GRRT: it means only the ``observed''
geodesics need to be calculated, and will appear to alter the
directions of rotations. There is consequently an additional minus sign when
determining the dot products of velocity vectors calculated this way.

Computing the geodesic equation requires some method of determining
$\utensor{\Gamma}{\mu}{\nu\sigma}$. This would usually be done analytically and
implemented directly into the code, which can be laborious. Computer algebra
systems are sometimes used instead, but this can lead to unnecessary
computations in the final expressions, and the systems can even occasionally
fail to calculate the Christoffel symbols if the metric becomes too complex.
Our method is to compute the Jacobian of the metric ($\partial_{\sigma} g_{\mu
\nu}$) needed in Eq.  \eqref{eq:christoffel} with AD\footnote{We were made
    aware by colleagues of the independently developed code Mahakala of
    \citet{sharma_mahakala_2023} that uses the same AD approach.}.
If the class of spacetime exhibits
additional symmetries, these can be exploited to reduce computation further: for
example, metrics of the form \eqref{eq:stationary_axisymmetric_metric} exploit
$\partial_t g_{\mu\nu} = \partial_{\phi} g_{\mu\nu} = 0$ (the principal Killing
vectors) and avoid calculating two columns of the Jacobian entirely.

\subsection{Observers and emitters}
\label{sec:observers-and-emitters}

\begin{figure}
    \centering
    \includegraphics[width=0.99\linewidth]{figures/skycoords.pdf}
    \caption{
    Geometry of the local sky for an observer or emitter. The image plane (yellow) is
    perpendicular to the $e_{(r)}$ axis, which for an observer points towards
    the global origin and therefore the central singularity. The momenta
    $v_{(\phi)}$ and $v_{(\theta)}$ are used to calculate the impact parameters
    on the image plane, $\alpha$ and $\beta$ respectively. For emitters, the
    angles $(\Upsilon, \Psi)$ are used to parameterize points on the local sky,
    that may be decomposed onto the basis $e_{(i)}$ to find $v_{(\mu)}$.
    }
    \label{fig:observer-coordinates}
\end{figure}

We calculate the initial velocity $v^i$ differently depending on whether we are
considering an \emph{observer} or an \emph{emitter} for the convenience of
parameterisation.

For observers, we are interested in the sparse set of emitted photons which
reach an image plane representing the observer's field of view, and therefore
parameterize the velocity vector using \emph{impact parameters} on the image
plane. The parameters representing the local sky are shown in
Fig.~\ref{fig:observer-coordinates}, with the image plane drawn in yellow.
Following \citet{cunningham_optical_1973}, one may then define a set of
\emph{impact
parameters} from components of the local momenta $v_{(i)}$
\begin{align}
    \alpha &:=  x^r \frac{v_{(\phi)}}{v_{(r)}}, \\
    \beta &:= x^r \frac{v_{(\theta)}}{v_{(r)}},
\end{align}
using indices in parentheses to denote the vector components in the local
frame. The choice of subscript ($r, \theta, \phi$) is to anticipate identifying
coordinate directions in the local and global (metric) bases, and to suggest
some intuition for the meaning of directions in the local frame.

Exploiting the invariance of four-momenta, similar to
\eqref{eq:velocity_constraint}, we obtain a curve of solutions along $x^r$ for
the local momenta of geodesics intersecting the image plane at specific
$\alpha$ and
$\beta$
\begin{align}
    \frac{v_{(r)}}{v_{(t)}} &= -\left( \sqrt{1 +
    \left(\frac{\alpha}{x^r}\right)^2 + \left(\frac{\beta}{x^r}\right)^2}
\right)^{-1} = -\mathscr{R}, \\
    \frac{v_{(\theta)}}{v_{(t)}} &= \mathscr{R} \frac{\beta}{x^r}, \\
    \frac{v_{(\phi)}}{v_{(t)}} &= \mathscr{R} \frac{\alpha}{x^r}.
\end{align}
Note the choice of sign in the root of $v_{(r)} / v_{(t)}$, chosen so the
momentum points \emph{inwards} towards the black hole.

The case for emitters is subtly different, where we now consider polar and
azimuthal angles in the local sky, denoted $\Upsilon$ and $\Psi$ respectively (see
also Fig.~\ref{fig:observer-coordinates}). The momentum components are now
obtained by considering the tangent vector pointing in some initial direction --
that is, by projecting the initial velocity vector onto the local momentum
frame. This projection is compactly expressed as a decomposition onto a
Cartesian coordinate system,
\begin{equation}
    \label{eq:local-angle-to-velocity}
    \frac{v_{(i)}}{v_{(t)}} = \frac{1}{v_{(t)}}
    \left[\pderiv{(x, y, z)}{(r, \theta, \phi)}\right]
    \left(
    \begin{matrix}
        \sin \Upsilon \cos \Psi \\
        \sin \Upsilon \sin \Psi \\
        \cos \Upsilon \\
    \end{matrix}
    \right),
\end{equation}
where the partial derivative matrix in square brackets denotes the Jacobian of
the Cartesian to spherical
coordinate transformation. The component $v_{(t)}$ is the negative of the energy in
the local frame, and $-v_{(t)}=E=1$ without loss of generality.

The transformation between local and global frame depends on the choice of local
frame. The natural choice is the \emph{locally non-rotating frame}
\citep[LNRF;][]{bardeen_rotating_1972}. This frame follows strictly
circular world lines with $x^r = \text{const.}$ and $x^\phi = \omega t +
\text{const.}$, with angular velocity $\omega = -g_{t\phi} / g_{\phi\phi}$. The
coordinate transformation from the LNRF is
\begin{equation}
    \label{eq:local-to-global-velocity}
    v_\mu = \e^{(\nu)}_{\phantom{(\nu)}\mu}\  v_{(\nu)}
\end{equation}
where the local tetrad (basis vectors) $\e^{(\nu)}_{\phantom{(\nu)}\mu}$ are found
using the theorem of Gram-Schmidt (\citealp{schmidt_uber_1989}, Appendix
\ref{appendix:gram-schmidt}). The formalism may be extended for a local frame
in motion, where the frame velocity modifies the mapping by a local Lorenz
transformation, $\Lambda^{(\kappa)}_{\phantom{(\kappa)}(\nu)}$, as
\begin{equation}
    v_\mu = \e^{(\nu)}_{\phantom{(\nu)}\mu}\  \Lambda^{(\kappa)}_{\phantom{(a)}(\nu)} v_{(\kappa)}.
\end{equation}
This Lorenz transformation may be absorbed into the tetrad with careful
construction, mandating the velocity of the frame in the global coordinates as
$\utensor{\e}{(t)}{\mu}$ and orthogonalizing using the theorem of Gram-Schmidt.

These calculations may also be derived from the constants of motion that a
spacetime admits, namely geodesic energy $E$, angular momentum $L$, and the Carter constant $Q$. The analytic
derivation of the LNRF and associated coordinate transformations is in
\cite{cunningham_optical_1973}. The authors derive the impact parameters under
the assumption that the observer is in asymptotically flat space, whereas our
calculations do not make this assumption. We can therefore use impact
parameters anywhere in the spacetime, and approximate an asymptotically flat
space by positioning our observer at a large radial distance, say $r_\text{obs}
> 10^4 \rg$. This approximation incurs an error of order $\sim1/r_\text{obs}$
when compared to results using asymptotic impact parameters due to the energy and
angular momentum differing by some small amount in the global coordinates.

\subsection{Special orbits and horizons}
\label{sec:special-orbits}

Of particular interest when studying accretion processes are the Keplerian
circular orbits \citep{shakura_black_1973}, confined to the equatorial plane in
axis-symmetric spacetimes $(x^\theta = \pi/2)$. These circular orbits are stationary points of the
Hamiltonian of a geodesic, and constrained by $v^r = v^\theta = 0$. They are
simple to study analytically and have a general solution for metrics of the form
given by eq. \eqref{eq:stationary_axisymmetric_metric} (see e.g.
\citealp{johannsen_regular_2013}, and our derivation with an extension
towards $a^\mu \neq 0$ in Appendix \ref{appendix:circular-orbits}).

Circular orbits are classified as either stable or unstable
\citep{wilkins_bound_1972,bardeen_rotating_1972}. There exists an innermost
stable circular orbit radius (ISCO, denoted $\risco$), below which orbits
are energetically hyperbolic: small perturbations will send test particles
escaping to infinity or spiralling into the central singularity. The stability of
an orbit depends on the sign of $\d E / \d x^r$, with $>0$ corresponding to
energetically stable configurations. The ISCO is the critical point at
which
\begin{equation}
    \label{eq:isco-definition}
    0 = \left. \frac{\d E}{\d x^r} \right\rvert_{x^r := \risco}.
\end{equation}
Stable circular orbits are only possible for radii $x^r \geq \risco$.  Within
the ISCO is the so-called \textit{plunging region} where $v^r \neq 0$.  Emission
from within the ISCO is generally disregarded in reflection and reverberation
models, though for specific disc models and/or inner boundary torques emission from
this region may be important
\citep[see e.g.][]{reynolds_isco_1997,young_isco_1998, mummery_continuum_2024}.
\Gradus makes no concrete
assumptions about the plunging region, though will omit inter-ISCO contributions in
this paper.

The ISCO radius may be solved numerically when no analytic solution is known.
For stationary, axis-symmetric metrics, the energy of a given orbit is known from
\eqref{eq:energy-of-orbit}, with the derivative with respect to $x^r$
calculated using AD. We use the NonlinearSolve.jl package to perform the root
finding on the resulting expression \citep{Pal_NonlinearSolve_jl_2023}.

The velocities of orbits in the plunging region are numerically calculated by
``dropping'' a test particle from $\risco -  \delta x^r$, and tracing for a
large interval of proper time, until the fate of the geodesic is realized. The
components of $v^\mu$ are then interpolated over $x^r$ to approximate analytic
solutions.

We implement a numerical method for determining the event horizon radius using a
similar approach. Under axis-symmetry, the event horizon is the set of $(r,
\theta)$ coordinates that satisfy
\begin{equation}
    \label{eq:event_horizon}
    0 = \left. \frac{1}{g_{rr}} \right\rvert_{x^r =: r_s}.
\end{equation}
For the cases where no analytic solution is known, we revert back to solving for
the event horizon using the root finding method as for the ISCO.

\subsection{Charts and horizons}

The \emph{chart} defines the boundaries of an integration domain that is used by the integrator to
terminate the computation when the fate of a given geodesic is sealed. In
practical terms, it is a set of `callback' functions in the integrator evaluated
at every step that may classify the outcome of
an integration (e.g. geodesic has stepped within the horizon, escaped to infinity,
intersected with the disc, and so on). In the majority of cases, the inner and outer
boundary of the integration chart are the event horizon $r_s$ and some
\emph{effective infinity} $r_\infty$ respectively -- the latter being when a
geodesic is assumed to escape the potential of the singularity without further
deviation to its trajectory.

The geometry of an accretion disc or object is also expressed as a boundary
(callback function) of the chart. By terminating the integration when the
geodesic intersects such a boundary, the geodesic is said to have intersected
the surface of the disc or object, and label it accordingly. These labels, termed
\emph{status codes}, are later used to group geodesic solutions together when
calculating physical quantities and observables.

Close to the inner radius the adaptive time step of certain ODE integration
algorithms will shrink dramatically due to near-singular derivatives, causing
the integration to slow almost to a standstill. We avoid this by scaling the
inner horizon with the choice of a constant $\mathcal{K} > 0$, such that
$\tilde{r}_s = (1 + \mathcal{K}) r_s$ is used to delineate the event horizon.
The constant $\mathcal{K}$ may be adjusted depending on need. We set
$\mathcal{K} = 10^{-2}$ (i.e. within 1\% of the true value) by default to
balance performance and accuracy.

\subsection{Observables}
\label{sec:computing-observables}

In \Gradus, an \textit{observable} is any physical quantity calculated from a
simulation. Computing an observable requires some or all points $p = (x^\mu,
v^\mu)$ along a geodesic, though often only the start and end points are
required. An observable that requires multiple points along the geodesic can be
calculated either coincidentally with the geodesic equation\footnote{The ODE
system is then modified with an additional differential equation representing
the observable.}, or subsequently re-traced along the ray. Such quantities
include parallel transport, polarisation, or radiative transfer quantities.
Calculating the quantities simultaneously has the benefit that the error
tolerance in the integrator is sensitive to changes in the observable. The
benefit of re-tracing is that for a given set of metric parameters and observer
positions, the trajectory of the geodesic is unchanged, so the observable may be
more efficiently recalculated.

A frequently used observables that only require the start and end point is the
\emph{redshift}, $g$. This redshift includes the Doppler shift, special
relativistic beaming, and gravitational redshift, and is compactly written
as the ratio of energies between the start and end point,
\begin{equation}
\label{eq:redshift}
g := \frac{E_\text{end}}{E_\text{start}} = \frac{\left. v_\mu u^\mu
\right\rvert_\text{end}}{\left. v_\mu u^\mu \right\rvert_{\text{start}}},
\end{equation}
where $v_\mu$ are the geodesic momenta, and $u^\mu$ the velocity of the emitting
(start) and observing (end) media respectively.



\subsection{Illumination and emissivity profiles}
\label{sec:emissivity-profiles}

The \emph{illumination profile} is the local flux of radiation on the disc as a
function of radius, $\varepsilon(\rho)$, for an axis-symmetric system, where
$\rho := x^r \cos (x^\theta)$. This is equivalently the \emph{emissivity
profile}, since the line strength in the
back-scattered spectrum is modelled to be proportional to the illuminating flux.
The illumination profile is related to the ionization parameter $\xi$ of
the accretion disc \citep{laor_line_1991,ross_reflection_1993,
wilkins_understanding_2012}, itself given by
\begin{equation}
    \xi = \frac{4 \pi F_i}{n_\text{H}}
\end{equation}
where $F_i$ is the total illuminating X-ray flux in a given energy band $i$, often in the range $0.01 - 100
\text{ keV}$, and $n_\text{H}$ is the co-moving hydrogen density
\citep{ross_effects_1993}.
For our purposes, we will drop factors considered to be constant, and use
$\varepsilon \propto F_i$ directly.

The source of $F_i$ is the luminous corona located close to the central
singularity \citep{svensson_corona_1994}. The geometry of the corona is
unknown, but is often modelled as a point source on the spin axis of the black
hole that emits isotropically, known as a ``lamppost'' corona
\citep{fukumura_accretion_2007}. Axisymmetric extended coronae are also
considered, and in general the morphology of the corona has a significant
effect of the emissivity profile \citep{wilkins_towards_2016,
gonzalez_probing_2017}.  For axisymmetric corona with isotropic emissions, the
incident flux (and therefore the emissivity profile), is a function of only the
cylindrical coordinate on the disc, $\rho = r \sin(\theta)$. The flux in an
annulus is the number density of photons along with an intensity
function $I$ representing the emission spectrum of the corona. Up
to a constant of proportionality, the emissivity function is
\begin{equation}
    \varepsilon (\rho, \d \rho) = \frac{\mathcal{N}(\rho, \d \rho)}{\gamma
    \tilde{A}(\rho, \d \rho)} I(g),
\end{equation}
where $\mathcal{N}$ is the geodesic count in an annulus $\rho + \d \rho$, $I$ is
the intensity of the illuminating flux as a function of redshift $g$,
$\tilde{A}$ is the curvature corrected (proper) area of the annulus, and
$\gamma$ is the Lorentz factor that accounts for area contraction of the annulus
due to the velocity of the disc.

The relativistic corrections are as follows: for an infinitesimal area $\d A = \d
\rho\d\phi$, the \textit{proper area} is calculated directly from the metric,
and so
\begin{equation}
    \d\tilde{A} = \sqrt{g_{rr} g_{\phi\phi}}\, \d \rho\, \d \phi,
\end{equation}
is the area as measured by a stationary observer in the disc. The relativistic
Lorentz factor is calculated as
\begin{equation}
    \gamma = \frac{1}{\sqrt{1 - \left(v^{(i)}\right)^2}},
\end{equation}
where $v^{(i)}$ are the spatial components of the angular velocity in the LNRF.
These components are determined for a given basis
\begin{equation}
    v^{(i)} = \frac{\utensor{\e}{(i)}{\mu}\, v^\mu}{\utensor{\e}{(t)}{\sigma}\, v^\sigma},
\end{equation}
where the special case of circular orbits in the equatorial plane only has
$v^{(\phi)}$ non-zero.

The emission spectrum for the illuminating corona is usually assumed to be a
powerlaw $I(g) = g^{-\Gamma}$ with photon index $\Gamma$ For most applications
$\Gamma = 2$ or $3$ \citep{mushotzky_agn_pl_1982,remillard_binaries_2006}. Our
models make no rigid assumptions about the coronal spectrum $I$, and any
arbitrary function of $g$ may be specified.

When the emission from the corona is assumed to be locally isotropic, geodesics
from the source are traced by sampling $\Upsilon$, $\Phi$ (angles on the sky,
see Figure \ref{fig:observer-coordinates}) evenly on a sphere.  The angles are
transformed via equations \eqref{eq:local-angle-to-velocity} and
\eqref{eq:local-to-global-velocity} to find the initial velocity of the
geodesic. Those geodesics that intersect with the disc are then used to
determine the number density, $\mathcal{N}$, and calculate the emissivity. When the emission in
non-isotropic, the sampled distributions of $\Upsilon$, $\Phi$ are
appropriately weighted.

For axis-symmetric point-source corona, the irradiating flux may alternatively
be determined by exploiting symmetries as in \cite{dauser_irradiation_2013}. A
set of photons with different polar angle $\Upsilon$, spaced evenly with some
$\Delta \Upsilon$, are traced and used to determine the radial boundaries of
the annuli on the disc, each with some width $\Delta r$, a proxy for reciprocal
photon number density, i.e. $\Delta r \propto 1 / \mathcal{N}$. For isotropic
emission, the polar coordinate is distributed as $\sin \Upsilon$, and therefore
$\varepsilon$ is weighted similarly,\footnote{Instead of equally spaced
    $\Upsilon$, one may instead sample $\Upsilon \sim \cos (1 - 2
    \mathcal{U})$, where $\mathcal{U}$ is a uniform distribution
    $\mathcal{U}(0,1)$. In this case, there is no $\sin \Upsilon$ weight in
$\varepsilon$. This result may be shown using the inverse-CDF or Smirnov
transform method.}
\begin{equation}
    \varepsilon(r, \Delta r) = \frac{\sin \Upsilon}{\gamma \tilde{A}(r, \Delta r)} I(g).
\end{equation}
An illustration of the two methods is shown in Figure \ref{fig:coronal-tracing}.
It should be noted that the latter method converges faster than the
former (Monte-Carlo) sampling approach, and captures the behaviour at small $r$
close to the ISCO faithfully -- behaviour that would otherwise require an
inordinate number of samples. However, since this method is specialized for
point sources, extended coronae require an approximate rebinning algorithm to
reconstruct the emissivity profile taking into account the overlap between the
annuli determined from different source points, or used to construct \emph{time-dependent} emissivity functions {\color{red} (Baker \& Young, in prep.)}.

\begin{figure}
    \centering
    \includegraphics[width=0.95\linewidth]{figures/emissivity.coronal-traces.pdf}
    \caption{An illustration of the methods described in the text for
        calculating the emissivity of a lamppost corona: the colourful lines are
        the null-geodesics of a lamppost model illuminating the accretion disc
        around in a maximally spinning Kerr spacetime ($a = 0.998$). Panel a) is
        the Monte-Carlo approach, where the initial velocity vector of the
        photon is sampled isotropically on the local sky of the emitter. The
        number density on the disc in a given annulus is then used as a proxy
        for the flux density. Panel b) shows how the symmetry of the lamppost can
        be exploited, by considering only a slice of the emission around the
        spin axis. The initial velocity vectors now differ by a constant $\Delta
    \theta$, which allows the spacing on the disc $\Delta r$ to be used as a
proxy for flux density.}
    \label{fig:coronal-tracing}
\end{figure}

% When axis-symmetry does not apply, we have developed a method for calculating
% the emissivity field as a function of $(r, \phi)$ on the disc by treating the
% points of intersection as the generators of a Delauney tesselation. The
% (relativistically corrected) Voronoi area may be used as a proxy for the photon
% number density $\mathcal{N} /\tilde{A}$  in the limit of high sample count (see
% Appendix \ref{appendix:voronoi}).

\subsection{Transfer functions}
\label{sec:transfer-functions}

\begin{figure*}
    \centering
    \includegraphics[width=0.95\linewidth]{figures/transfer-function.parameterization.pdf}
    \caption{Concentric rings of radius $r_\text{em}$ and contours of constant
    dimensionless redshift $g^\ast$ on disc in the equatorial plane, projected
on the image plane of a distant observer at $\theta_\text{obs} = 75^\circ$. The
central singularity is described by the Kerr metric with $a = 0.998$. The
innermost thick black line is the projection of the ISCO. Note the contours of
$g^\ast$ are double valued for any given $r_\text{em}$. Panel a) geometrically
thin disc. Panel b) \citet{shakura_black_1973} Disc (SSD) with $\dot{M} / \dot{M}_\text{Edd} = 0.3$, with
obscuration of some of the inner radii. The edge of the ISCO is here only
partially visible.}
    \label{fig:transfer-parameterisation}
\end{figure*}

To motivate the use of \emph{transfer functions}, consider the calculation of an
observed spectrum of flux reflected by the accretion disc. The infinitesimal
flux element, $\d F(E)$, is related to the specific intensity in the solid angle element
\begin{equation}
\label{eq:infinitesimal-flux}
\d F(E) = I(E)\, \d \Omega,
\end{equation}
for observed energy $E$, specific intensity $I$ and solid angle $\d \Omega$.
\cite{cunningham_effects_1975} gives an intuitive relation between the observed
and emitted intensities as derived using the \emph{reciprocity theorem} \citep[or
equivalently \emph{Liouville's theorem};][]{lindquist_louville_1966} with
\begin{equation}
\label{eq:liouville-theorem}
I_\text{obs}\left( E_\text{obs}\right) = g^3 I_\text{em}\left(E_\text{em}\right).
\end{equation}
Integrating over $\d \Omega$ to obtain the observed flux $F(E_\text{obs})$ is
equivalent up to a constant to integrating over the image plane $\d \alpha \d
\beta$,
\begin{equation}
\label{eq:integrate-impact-params}
F(E_\text{obs}) \propto \int I_\text{obs}(E_\text{obs}) \d \alpha \d \beta,
\end{equation}
which in practical terms is binning the geodesic in each pixel over bins of
$\Delta E$.  Formulating the flux calculation in this way is computationally
simple but expensive, as the flux is computed on a pixel-by-pixel
(geodesic-by-geodesic) basis. The emitted intensity $I_\text{em}$ depends on the
disc emissivity, requiring both coordinate and redshift values for each geodesic
to be stored in memory. These quantities are dependant on the metric,
disc, and observer parameters, and this dependence limits the reuse of
calculations between simulations -- an undesirable property for performant spectral models.

To avoid such problems, the relativistic effects in the flux calculation are
often encoded in so-called \emph{transfer functions}
\citep[e.g.][]{brenneman_constraining_2006}. The most ubiquitous formulation of these
transfer functions was first introduced in \cite{cunningham_effects_1975}.
There, they are defined
\begin{equation}
    \label{eq:cunn-transfer-function}
    f:=\frac{g}{\pi r_\text{em}} \sqrt{g^\ast(1 - g^\ast)} \jacobian{(\alpha, \beta)}{(r_\text{em}, g^\ast)},
\end{equation}
where $r_\text{em}$ is the emission radius on the disc, and
\begin{equation}
    g^\ast := \frac{g - g_\text{min}}{g_\text{max} - g_\text{min}} \in [0, 1],
\end{equation}
is a rescaled dimensionless redshift parameter. The extremal values of $g$ are
calculated over a given emission radius on the disc, $r_\text{em}$.

The parameterization of $g^\ast$ is double-valued everywhere except at $g^\ast =
0$ and $1$, with the two branches of $g^\ast$ being attributed to the sections of the
disc closest and furthest from the observer. This naturally leads to the
interpretation of the Cunningham transfer functions as recasting the projection
of the accretion disc on the image plane from $(\alpha, \beta)$ to
$(r_\text{em}, g^\ast)$, see Figure \ref{fig:transfer-parameterisation}.  The
additional elliptical envelope in $g$ suppresses the singular values of the
Jacobian as $g^\ast$ becomes $0$ or $1$, resulting in numerically better behaved
functions at extremal $g^\ast$.

As a note, the name \emph{transfer functions} is a more general term and used
elsewhere, for example in reverberation simulations discussed later. To avoid
ambiguity, we henceforth refer to functions of the kind defined in equation
\eqref{eq:cunn-transfer-function} as \emph{relativistic} or \emph{Cunningham
transfer functions}. Furthermore, the Cunningham transfer functions are referred
to as having ``upper'' and ``lower'' branches between extremal $g^\ast$, as
shown in Figure \ref{fig:transfer-sampling-pattern}, stemming from the double-valued
nature of $g^\ast$. When the emission from the disc is not isotropic, the
distinction between these branches becomes important, as the generating geodesic makes a different cosine angle $\mu$ to the disc surface. Cunningham transfer
functions also make a number of assumptions about the system under
consideration, principally that only one side of the disc contributes to the
flux (no false images).

\subsubsection{Calculating Cunningham transfer functions}

Before integrating the Cunningham transfer functions, we must first calculate
them. Our method for calculating $f$ is a variation of the algorithms of other
authors (\citealp{speith_photon_1995,bambi_testing_2017}, improved in
\citealp{abdikamalov_public_2019}), and uses AD to compute the Jacobian term. The procedure is as follows.

First, we find the impact parameters that map to a
ring of radius $r_\text{em}$ on the accretion disc. In the case of simple
axis-symmetric discs, the projection of a ring will be the boundary of a
star-convex set on the image plane, and therefore a polar curve
$\mathcal{R}(\vartheta)$, with $\alpha = \mathcal{R}(\vartheta) \cos(\vartheta)$
and $\beta = \mathcal{R}(\vartheta) \sin(\vartheta)$. For a given $\vartheta$,
the offset on the image plane $\mathcal{R}$ is found by root-finding the
difference between $r_\text{em}$ and the projected endpoint of the geodesic on
the disc $r = x^r (\mathcal{R}) \sin x^\theta(\mathcal{R})$, using the same
alternating root-finder as in Section \ref{sec:special-orbits}.

Second, we must determine the extrema of $g$ over the $r_\text{em}$ ring. The
extremal $g$ are found by using the Golden-Section bracketing method of
\cite{Optim.jl-2018} to extremize $g(\vartheta)$, solving a new geodesic
at each step. We make the assumption that extremal $g$ approximately coincide
with extremal $\beta = 0$, and therefore shift the domain to $\vartheta \in [
-\pi/2, 3\pi/4)$ to ensure the maxima and minima are away from the edges of the
domain to help the optimizer.

The importance of accurately calculating $g_\text{min}$ and $g_\text{max}$ is
difficult to overstate: small errors here will dramatically alter the shape of
the transfer functions close to $g^\ast \rightarrow 0$ and $g^\ast \rightarrow
1$, and have a high likelihood of sending $f$ to positive or negative infinity.
Even when the extrema are determined to high accuracy, in practice, it is useful
to employ a small truncation of $\delta g^\ast = h \sim 10^{-6}$ either side
of the domain. This is discussed in the next
section in further detail in the context of integrating $f$.

Finally, the Jacobian is calculated by retracing all previously traced $(\alpha,
\beta)$ that map to $r_\text{em}$ with AD. Other authors will here use
\begin{equation}
    \left\lvert
    \pderiv{(\alpha, \beta)}{(r_\text{em}, g^\ast)}
    \right\rvert
    =
    \left\lvert
    \pderiv{r_\text{em}}{\alpha}\pderiv{g^\ast}{\beta}
    -
    \pderiv{r_\text{em}}{\beta}\pderiv{g^\ast}{\alpha}
    \right\rvert^{-1},
\end{equation}
and determine the derivatives with a finite difference stenciling approach, or
even use a fixed $\delta \alpha$ and $\delta \beta$. Unless the algorithm can
adapt extremely well, this approach may introduce singular values or risk large
numerical error at extremal $g$. AD avoids some of these problems, and has the
additional benefit that it only requires the evaluation of a single geodesic to
compute.

The total number of geodesics traced for each Cunningham transfer function
depends on the number of steps needed to solve impact parameters for a given
$r_\text{em}$, and on the number of steps needed to extremize $g^\ast$ to within
some tolerance. In our code, we set an upper-limit on the number of steps so
that memory can be contiguously allocated, at the cost of possibly curtailing some
calculations before tolerance is reached. Our default configurations use an upper limit of $N = 114$ points
along $r_\text{em}$, $80$ of which are approximately linearly sampled in
$\vartheta$, and $34 = 2 \times 17$ used to determine $g_\text{min}$ and
$g_\text{max}$. These limits were chosen to balance speed and accuracy of
calculation. The resulting sampling pattern is sensitive to various extrema in
$g$, and determines the shape of $f$ well, as shown in Figure
\ref{fig:transfer-sampling-pattern}.

\begin{figure}
    \centering
    \includegraphics[width=0.95\linewidth]{figures/transfer-functions.sampling.pdf}
    \caption{Transfer functions of the Kerr spacetime ($a = 0.998$) for various
        observer inclinations, showing the sample pattern of $g^\ast$ that our
        algorithm (described in the text) produces. The higher
        density of points around extremal $g^\ast$ is due to the optimizer we
        employ to determine the extremal points. Note that for the high
        inclination case ($\theta = 85^\circ$) there is slight numerical noise
        very close to $g^\ast = 1$. This noise is in the region excluded by the
        integration scheme, and therefore contributes negligible error in
        calculations involving transfer functions. There is also a high density
        of points on the lower branch of the transfer function, which is an
        artefact of the projection of the disc onto the observer's plane.
    }
    \label{fig:transfer-sampling-pattern}
\end{figure}

\subsubsection{Partially obscured Cunningham transfer functions}
\label{sec:partially-obscured-functions}

For thick accretion discs, it is possible that the disc obscures itself, and
that certain $r_\text{em}$ may therefore be only partially visible or entirely
obscured to an observer at inclination $\theta_\text{obs}$ (see Figure
\ref{fig:transfer-parameterisation}b). When this is the case, the method of
calculating Cunningham transfer functions is modified through the use of
\emph{datum planes}.

We define a \emph{datum plane} to be an infinite plane at some scale height
$z_\text{em} = r_\text{em} \cos \theta$, and used as the manifold over which the
optimizer solves the projection of the ring at $r_\text{em}$. The datum plane
is in essence a cut-off for integration such that all geodesics terminate with
the same $z$, see Figure \ref{fig:datum-plane-tracing}.

As before, we determine the extremal redshift over the ring $r_\text{em}$,
including those geodesics from obscured regions of the disc. As the redshift
depends only on the start and end point of the geodesic, it is therefore simpler
to combine this with the radius-solving step and calculate the redshift over the
datum plane. This is not so for the Jacobian term, which depends on the cross
section traced by a bundle of geodesics for which the geometry of the disc is
important. The Jacobian is calulated by tracing against the thick disc and is
combined with a check to see if a patch of the disc is obscured. This
obscuration check is used to mask the transfer functions, as in Figure
\ref{fig:transfer-functions}. This method is in effect analogous to the
``imaginary photons'' of \cite{abdikamalov_testing_2020}, but formalized for
optimizing $r_\text{em}$ and AD.

\begin{figure}
    \centering
    \includegraphics[width=0.95\linewidth]{figures/datum-plane.pdf}
    \caption{Cross-sectional slice of geodesics traced from a distant observer
        against a datum plane (horizontal blue line) through a thick disc
        (curved black line). The observer ``sees'' the solid geodesics
        intersecting the disc, whereas for the purposes of calculating the
        Cunningham transfer functions, we continue integrating along the dashed
        line until intersecting the datum plane. For geodesic A the observer
        can see the emission radius $r_\text{em}$, whereas for B the radius is
        obscured.
}
    \label{fig:datum-plane-tracing}
\end{figure}


\begin{figure*}
    \centering
    \includegraphics[width=0.99\linewidth]{figures/transfer-functions.plots.pdf}
    \caption{Transfer functions $f$ and timing $t$ for fixed $r_\text{em}$ for different observer inclinations $\theta_\text{obs}$ and $r_\text{obs} = 10^3 \rg$. Panels a) and b) Schwarzschild spacetime with equatorial thin disc and $r_\text{em} = 11\, \rg$. Panels c) and d) Maximally spinning Kerr spacetime $a=0.998$ with equatorial thin disc and $r_\text{em} = 4 \, \rg$ (see also \citealp{bambi_testing_2017}, their Figure 1). Panel e) and f) Maximally spinning Kerr spacetime $a=0.998$, with SSD $\dot{M} / \dot{M}_\text{Edd} = 0.3$ and $r_\text{em} = 4\, \rg$, showing obscuration at steep inclination.}
    \label{fig:transfer-functions}
\end{figure*}

\subsection{Integrating transfer functions}
\label{sec:transfer-function-integration}

Using the Cunningham transfer functions as a Jacobian allows us to rewrite the
integration \eqref{eq:integrate-impact-params} as
\begin{equation}
    F(E_\text{obs}) = \int \frac{\pi r_\text{em} f(r_\text{em}, g^\ast)}{g \sqrt{g^\ast (1 - g^\ast)}}
    I_\text{obs}(E_\text{obs}) \ \d r_\text{em} \d g^\ast,
\end{equation}
where we can use Liouville's theorem \eqref{eq:liouville-theorem} to express the
observed intensity in terms of the emitted intensity, and write $E_\text{obs} =
E_\text{line}g$ . The integrand is then only a function of $r_\text{em}$ and
$g^\ast$. We here see a new meaning for the Cunningham transfer functions,
namely as the Green's function of an annulus $r_\text{em}$ in response to some
delta function of $I_\text{em}$. This interpretation is used to guide
integration schemes for the transfer functions \citep{dauser_broad_2010}.

The Cunningham transfer functions are split into the aforementioned
upper and lower branches at extremal $g^\ast$, and each branch is integrated
separately, with the total summed in the final result. We extend the transfer
function integration to include the geodesic coordinate time, resulting in the
integral
\begin{align}
    \label{eq:transfer-integration}
    F(E, t) &=
    \pi
    \int_0^\infty \d t^\prime \delta(t - t^\prime)
    \int_{r_\text{in}}^{r_\text{out}} \d r_\text{em}\,r_\text{em} \nonumber \\
    &\ \int_0^1 \d g^\ast\, \delta(E - gE_\text{line})\, g^3 I_\text{em}\left(\frac{E}{g}, t^\prime\right) \frac{f(r_\text{em}, g^\ast)}{\sqrt{g^\ast (1 - g^\ast)}},
\end{align}
denoting $g = g( r_\text{em}, g^\ast, t')$ implicitly. We use the Dirac delta
functions to select the $E$ and $t$ bins of the observed flux respectively,
however we note that at no point can we continuously evaluate the integrand, and
this notation serves only to express what we are trying to do. In practical
terms, we have a discrete set of Cunningham transfer functions over which can
can smoothly interpolate. The method for numerically integrating the
time-dependent transfer functions is as follows: the limits of the integral are
chosen $r_\text{in}, r_\text{out}$, as are the limits of the output space
similarly $E_\text{min}, E_\text{max}$, and $t_\text{min}, t_\text{max}$. Any
evaluation of \eqref{eq:transfer-integration} that is outside of the energy and
time limits is discarded. The integration over $\d r_\text{em}$ is performed
using a trapezoidal scheme, as it is found to be sufficient in both accuracy and
performance. For the integration over $\d g^\ast$ we must be more careful, especially near the extremal values. For this we use a quadrature integration scheme, where $F(E)$ is evaluated for each branch over a small
output bin in $g$, such that $t$ is determined by evaluating $t(g^\ast)$ at the
limits of the bin. These approximations require that the
integration is performed over a fine $g$ grid to be sufficiently accurate. In full:
\begin{enumerate}
    \item Interpolate the values of the transfer function, $f$, $t$, and
        $g_\text{min}$, and $g_\text{max}$, for the current radius $r_i$.
    \item Calculate the trapezoidal integration weight for the radial coordinate
        $\omega_i = \Delta r_i r_i$. Any other quantities that only depend on
        $r_\text{em}$ may similarly be factored into this weight, e.g. if
        $I_\text{em} = I_\text{em}(r_\text{em})$.
    \item For each bin in the fine $g$ grid, integrate $f$ over this bin. Record
        $t_\text{min} = t(g_\text{min})$ and $t_\text{max} = t(g_\text{max})$.
        Note that depending on the interpolation scheme or implementation, if $f$ is a function of
        $g$ instead of $g^\ast$, a $g / (g_\text{max} - g_\text{min})$
        change-of-variable factor must be included in the integrand.
    \item Add $\omega_i F_i(E, t)$ to the bin corresponding to $E =
        gE_\text{line}$, and $t(g^\ast)$ for each branch. If either $\Delta E$
        or $\Delta t$ straddles an output bin, the flux must be weighted
        appropriately and divided into those bins.
\end{enumerate}

The integrand for each branch remains in practice singular at $g^\ast
\rightarrow (0, 1)$, and therefore the integration is performed over $g^\ast \in
[h, 1 - h]$. Outside of this domain, the limits of the integrand can be taken to
approximate the edges of the bin, as in \cite{dauser_broad_2010},
\begin{equation} F_\text{edge}(E,t) \propto 2\left( \sqrt{E_\text{max}} -
\sqrt{E_\text{min}} \right).  \end{equation} The constant of proportionality is
determined from evaluating the integrand at $h$ or $1 - h$ respectively.

We use $h = 2 \times 10^{-8}$, and evaluate the integral over $\d g^\ast$ using
a 7$^\text{th}$ order Gauss-Kronrod quadrature scheme, which avoids evaluating
the integral directly at $h$ and $1 - h$. Finer grids for $r_\text{em}$
and $g^\ast$ are constructed to help with numerical accuracy and stability, with
the finer bins subsequently rebinned into the desired output grid\footnote{The
    grid in $r$ should be regularly spaced, e.g. $\sim 1 / r$, reflecting the
    fact that the majority of the variation in $f$ occurs at small $r$. For
$g^\ast$, the variation is approximately uniform over the domain, and so we use
a uniform grid of $N = 30$ points over $g^\ast$. This also make saving the
transfer functions in a tabular format simple.  }.

By formulating the Cunningham transfer function integration with the time
component, we can use the same transfer function table to compute both
line-profiles and timing properties (e.g., reverberation lags) efficiently, with arbitrary intensity
functions $I_\text{em}$. We note that extensions to $I_\text{em}$ that require,
for example, the photon emission angle on the disc $\mu = \cos(\theta)$ \citep{matt_reflection_1993}, are
simple to include.

% These transfer function integration methods may be checked for consistency
% against slower but simpler direct binning of the image plane via Eq.
% \eqref{eq:infinitesimal-flux} and Eq. \eqref{eq:liouville-theorem}.

\subsection{Covariant radiative transfer}

The intensity of a given geodesic is an observable that can be either calculated coincident with the geodesic trajectory, or retraced once the trajectory is determined.

The covariant formulation of the radiative transfer equation calculates the emissions and extinction in a frame co-moving with the geodesic \citep{fuerst_radiation_2004,younsi_general_2012}. The generalized form of the differential equation with respect to the affine parameter $\lambda$ can be written in terms of the Lorentz invariant intensity $\mathcal{I} = I_\nu / \nu^3$ \citep{lindquist_louville_1966} as follows,
\begin{equation}
    \label{eq:covariant-radiative-transfer}
    \frac{\d \mathcal{I}}{\d \lambda} = \left. \frac{\d s}{\d \lambda} \right\rvert_\lambda \left( -\alpha_\nu \mathcal{I} + \frac{j_\nu}{\nu^3} \right),
\end{equation}
where $\mathcal{I}$ is the invariant intensity, $s$ is the proper length traversed by the geodesic, and $\alpha_\nu$ and $j_\nu$ are the frequency $\nu$ dependent absorption and emissivity coefficients respectively, as measured in the local frame. The frequency $\nu$ is related to the observed frequency via the redshift
\begin{equation}
    g = \frac{\nu_\text{obs}}{\nu},
\end{equation}
In general, both coefficients $\alpha_\nu$ and $j_\nu$ are also functions of the position $x^\mu$.

The $\d s / \d \lambda$ derivative term is calculated by projecting the geodesic momentum $v_\mu$ onto the velocity $u^\mu$ of the medium, using the projection tensor
\begin{equation}
    \mathrm{P}^{\mu\nu} := g^{\mu\nu} + u^\mu u^\nu.
\end{equation}
The path length derivative is
\begin{align}
    \left. \frac{\d s}{\d \lambda} \right\rvert_\lambda
    &= - \left. \left\lVert \mathrm{P}^{\mu\nu} v_\mu\right\rVert\, \right\rvert_\lambda,\\
    &= - \left. \sqrt{v_\mu v^\mu + \left(v_\mu u^\mu\right)^2 \left(2 + u^\mu u_\mu\right)} \, \right\rvert_\lambda,
\end{align}
such that for the particular case of null geodesics through a time-like medium
\begin{equation}
    \left. \frac{\d s}{\d \lambda} \right\rvert_\lambda = - \left. v_\mu u^\mu \right\rvert_\lambda.
\end{equation}

The intensity is therefore calculated by selecting $\nu_\text{obs} = E$ at the observer, and integrating \eqref{eq:covariant-radiative-transfer} along a given geodesic.


%%% DESCRIPTION OF THE CODE %%%%%%%%%%%%%%%%%%%%%%
\section{Description of the code}
\label{sec:description-of-code}

\Gradus is implemented in the Julia programming language
\citep{Bezanson_Julia_A_fresh_2017}. We use the DifferentialEquations.jl
solving library with ForwardDiff.jl for forward-mode automatic differentiation
\citep{RevelsLubinPapamarkou2016}. The code is available via the \texttt{Pkg}
Julia package manger in a registry maintained by the University of
Bristol astrophysics
group\footnote{\url{https://github.com/astro-group-bristol/AstroRegistry/}}.

\Gradus aims to have a single expressive high-level programming interface for a
variety of GRRT problems, with sensible defaults and optional fine-grained
control. The code is accompanied by HTML
documentation\footnote{\url{https://astro-group-bristol.github.io/Gradus.jl/}},
with short tutorials and examples designed to provide a feature-rich overview
whilst simultaneously demonstrating how to construct custom simulations, and how
to integrate \Gradus in user models. We encourage readers who are interesting in
learning up-to-date information about the code and our methods to consult the
documentation, as the documentation will be a more accurate description of the
code as it is developed and maintained. The documentation details all algorithm
specific choices and implementations. The source code is written to be read by
contributors and users alike to invite extension, to be explicit about our
methods, and their benefits and limitations.

\Gradus is extensively tested with a suite of unit and integration tests. The
tests are constructed both by comparing numerical algorithms to specific
analytic counterparts, and by comparing against snapshots of results in the
literature. Where two (or more) methods exist to compute an observable, \Gradus
implements both as a method of verification. This ensures our computations are
at least self-consistent when implementing new algorithms.

In our discussion of the numerical methods, we note the current default ODE
integration algorithm is Tsitouras Runge-Kutta 5/4
\citep{tsitouras_rungekutta_2011}. \Gradus vendors additional ODE solvers and
numerical algorithms from the Julia SciML ecosystem, with both adaptive and
fixed time steps, that may provide performance or accuracy improvements for
specific problems.

\Gradus aims to make exploring new spacetime models simple by only requiring the
non-zero metric components to be implemented. To this end and for comparison, we
maintain a catalogue of predefined metrics, including the Kerr spacetime,
Morris-Thorne wormhole, Johannsen-Psaltis metric, the Einstein-Maxwell
Dilaton-Axion metric \todo{citations for these}, the No-$\mathbb{Z}_2$ metric, and
the Kerr-Newman metric, complete with the ability to specify the electromagnetic
potential vector, from which external accelerations $a^\mu$ in
equation \eqref{eq:geodesic_equation} are calculated.

\subsection{Extensibility}

The design of \Gradus prioritizes usability and extensibility, which comes at a
small performance cost: our aim is not to implement the fastest, semi-analytic
solutions to specific problems, but rather to have an optimal and interpretable
codebase for exploring problems related to general relativity. The abstractions
in \Gradus have been designed to allow users to implement and calculate
observables of their models quickly. To this end, we also include a number of
visualization and plotting recipes to provide some intuition for the problem
space.

This design is possible with Julia's just-in-time compilation and multiple
dispatch, which also brings additional benefits: different number types may be
used through the whole library, such as arbitrary precision floating point
operations, symbolic types through Symbolics.jl \citep{symbolics_julia}, or the
propagation of AD gradient information through an entire simulation.
Consequently, our code can calculate derivatives of any physical product with
respect to the input parameters, optimal for use directly in model fitting or
for generating machine-learning surrogate models.

% The shim we have implemented between our ODE problems and
% DifferentialEquations.jl allows additional quantities to be integrated along
% with the geodesic equation, as described in Section
% \ref{sec:computing-observables}. The abstraction permits users of \Gradus to
% easily specify new ODE components to be traced, if their model requires them
% (e.g. path length of a geodesic or polarization parameters).

% Our transfer function integration routines permit arbitrary kernels, allowing
% any quantity integrated over the image plane to be efficiently pre-computed and
% calculated via transfer functions. Where additional information about the
% geodesics is needed, our extension to include the timing component serves as an
% example of the methods we have developed to permit this.

%%% TEST PROBLEMS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Test problems}
\label{sec:test-problems}

In this section we validate our code by comparing with a number of standard
test cases from the literature, and discuss the impact of the extensions to our
numerical methods.
Unless otherwise stated, all test problems are integrated with the Tsitouras 5-4
algorithm \citep{tsitouras_rungekutta_2011}. We also consider Faegin's
10$^\text{th}$ order Runge-Kutta method, the explicit Runge-Kutta 4$^\text{th}$
order algorithm \citep{press_numerical_2007}, and Verner's ``Most Efficient''
6-5 Runge-Kutta method.  These are all implemented in the Julia
DifferentialEquations.jl package \citep{rackauckas_differential_2017}.

\subsection{Integration accuracy and stability}

Since our method for integration does not use constants of motion directly, the
stability of the integrator may be evaluated by calculating these constants or
other invariant quantities along the trajectory. In Figure
\ref{fig:dot-stability} we show the invariant $v_\mu v^\mu$ for a geodesic that
spirals into a maximally spinning black hole. The magnitude of the invariant is
shown for a sample of integration algorithms, along with the time-to-solution
for the geodesic. Note that this solving time includes the time to initialize the
integrator, calculate the full trajectory (with interpolants), and package the
solution structure.

\begin{figure}
    \centering
    \includegraphics[width=0.95\linewidth]{figures/stability.conservation.pdf}
    \caption{A comparison of different ODE integration algorithms using the default
    tolerances $\text{abstol} = \text{reltol} = 10^{-9}$. Panel a) shows the
    null-geodesic of the Kerr spacetime, $a = 0.998$, for impact parameters
    $\alpha = 5$ and $\beta = 0$ integrated from the starting position $x^r =
    10^4 \rg$ and $x^\theta = \pi / 2$. All of the algorithms considered
    yield the same solution. Panel b) shows the integration time for the
    geodesic considered. The integration time is approximately equal for all of
    the algorithms except for RK4. Panel c) shows the value of the conserved
    quantity $g_{\mu \nu} v^\mu v^\nu = 0$ along the trajectory, used as a
    measure of stability of the integration algorithm.
}
    \label{fig:dot-stability}
\end{figure}

To test accuracy we calculate the angular deflection. The deflection is
the difference in $x^\phi$ of a geodesic traveling from positive to negative
infinity, that is
\begin{equation}
    \delta x^\phi :=
        x^\phi_{+\infty} - x^\phi_{-\infty}
        - \pi,
\end{equation}
where $\pi$ is the angular change for a trajectory that experiences no
deflection. Semi-analytic solutions for the deflection angle in the Kerr
spacetime have been calculated for equatorial geodesics in
\cite{iyer_lights_2009}. The authors use elliptical integrals to find the
coordinate differences. We follow their notation and denote the \emph{analytic}
deflection angle $\hat{\alpha}$.

Figure \ref{fig:deflection-angle} shows the deflection angle as a function of
impact parameter $\alpha$, along with a  measure of the error for the different
integration algorithms. There is asymptotic behaviour of the error as $\lvert
\alpha \rvert$ increases. This is related to our approximation of an ``observer
at infinity'' discussed in Section \ref{sec:observers-and-emitters}. As can be
expected, the error increases if $x^r_\text{start}$ is decreased, and
vice-versa. Here we again see the impact that the choice of integrator can have
on numerical errors.

\begin{figure}
    \centering
    \includegraphics[width=0.94\linewidth]{figures/deflection.iyer-hansen.pdf}
    \caption{Deflection angle in the Kerr spacetime ($a = 0.998$) for geodesics in the equatorial plane over a range of impact parameters $\alpha$. Upper panel: numerical deflection $\delta x^\phi$ calculated with  $x^r_\text{start} = 2 \times 10^8 \, \rg$, absolute and relative tolerances set to $10^{-14}$, and effective infinity $4 \times 10^8\, \rg$, shown with the numerical solutions for $\hat{\alpha}$. Lower panel: the absolute relative error between the numeric and analytic deflection angles for different integration algorithms.}
    \label{fig:deflection-angle}
\end{figure}

\subsection{Emissivity profiles}

To test our implementation of the emissivity profile calculations described in Section \ref{sec:emissivity-profiles}, we
model a thin equatorial accretion
disc illuminated by an on-axis lamppost corona, comparing our results against
\cite{wilkins_understanding_2012} and \cite{dauser_irradiation_2013}. These are
shown in Figure \ref{fig:emissivity-profiles} and are in good agreement with
the published results. Also shown is the effect of the Shapiro delay $t$, on the
arrival time of a photon at a given radius on the disc.

\begin{figure}
    \centering
    \includegraphics[width=0.99\linewidth]{figures/emissivity.point-source.pdf}
    \caption{Emissivity profiles, $\varepsilon(\rho)$ for a lamppost point source illuminating a thin, equatorial disc at various heights
        above the spin axis of a maximally spinning Kerr black hole ($a =
        0.998$). Panel a) shows the emissivity profiles in arbitrary flux units.
        Panel b) is the $\alpha$ exponent of the emissivity profile found by
        differentiating the emissivity profile as $r^{-\alpha}$.  Panel a) and
        b) are to be compared to Figures 2 and 3 in
        \citet{dauser_irradiation_2013}. Panel c) is the light-travel time of
        the photon from the lamppost to the disc. The increase in light travel
        time at small radii is due to the strong gravity effects.
}
    \label{fig:emissivity-profiles}
\end{figure}

Modifying the geometry, or adding instantaneous velocities to the corona have
been explored in \cite{gonzalez_probing_2017}. The emissivity curves calculated
are for extended corona are then the time-averaged emissivities on the disc.
These emissivities can be approximately calculated using a Monte-Carlo approach,
by sampling (uniformly) random points in the volume of the corona as the sources
of isotropic emission. The relevant transformations for mapping the local
emission vectors back to the global coordinates is the same as discussed in
Section \ref{sec:observers-and-emitters}.

\subsection{Line profiles}

The rest-frame accretion disc spectrum is modified by relativistic effects producing an observed spectrum in which emission lines have a broad and skewed \emph{line profile}.
To calculate these line profiles, transfer functions are integrated for a particular emissivity profile as described in Section
\ref{sec:transfer-function-integration}, neglecting the timing components.
Figure \ref{fig:relline-comparison} compares the line profiles computed using
the transfer functions of \Gradus and the \relline model of
\cite{dauser_broad_2010}\footnote{We compare against the \relline v2.3 with
table v0.5a distributed in the Relxill package
\url{http://www.sternwarte.uni-erlangen.de/~dauser/research/relxill/}. These are
the latest versions at the time of writing.}. We see good agreement to within $\sim
1\%$ accuracy.

\begin{figure}
    \centering
    \includegraphics[width=0.99\linewidth]{figures/lineprofiles.comparison.pdf}
    \caption{Comparison of line profiles calculated by integrating transfer functions with emissivity $I_\text{em} = \varepsilon(r_\text{em}) = r_\text{em}^{-3}$ using \Gradus and \relline. The transfer functions are calculated for an observer at $r_\text{obs} = 1000\rg$ and $\theta_\text{obs} = 40^\circ$, and integrated between $r_\text{in} = \risco$ and $r_\text{out} = 50 \rg$. Left panel is the the maximally spinning Kerr spacetime, whereas the right panel is the Schwarzschild spacetime.}
    \label{fig:relline-comparison}
\end{figure}

In addition to comparing to published results, \Gradus offers self-consistent
checks by calculating line profiles using both Cunningham transfer functions and
direct $\alpha, \beta$ photon binning. This is useful especially for unusual
disc geometries, where obscuration effects make calculating the Cunningham
transfer functions difficult, as described in
\ref{sec:partially-obscured-functions}. In Figure \ref{fig:line-profile-ssd} we
show line profiles for the \citet{shakura_black_1973} Disc (SSD) model using a fixed power-law emissivity
function, with both numerical methods yielding identical line profiles,
indicating our datum plane method is valid.

\begin{figure}
    \centering
    \includegraphics[width=0.99\linewidth]{figures/lineprofiles.ssd.pdf}
    \caption{Line profiles for the SSD with $\dot{M} / \dot{M}_\text{Edd} = 0.3$ for different observer inclinations $\theta_\text{obs}$ and emissivity $I_\text{em} = \varepsilon(r_\text{em}) = r_\text{em}^{-3}$. The transfer functions are calculated as in Figure \ref{fig:relline-comparison}, and integrated over the same limits. The light-grey lines correspond to the geometric thin disc ($\dot{M} / \dot{M}_\text{Edd} = 0$), and differ only for steep inclinations due to obscuration of the inner $r_\text{em}$. Left panel is the the maximally spinning Kerr spacetime, whereas the right panel is the Schwarzschild spacetime.}
    \label{fig:line-profile-ssd}
\end{figure}


\subsection{Reverberation lags}
\label{sec:lag-transfer-functions}

AGN and XRBs exhibit a phenomena where the high energy X-ray emission from the
corona is observed both directly and a short delay later after being reprocessed
by the accretion disc. The time delay between the direct and ``reflected''
components is increased by the effects of strong gravity on the light travel
time, and therefore depends on properties of the black hole, as well as
depending on the disc and corona geometry. These lags are known as
\textit{reverberation lags} (see e.g. \cite{uttley_x-ray_2014} or
\cite{cackett_reverberation_2021} for a review).
% Reverberation lags difficult to
% observe in light curves directly, and so are typically expressed as a time lag
% as a function of Fourier phase frequency of the driving continuum signal, or as
% a time lag between energy bands.

Simulating either the lag-frequency or lag-energy spectra involves computing a
set of transfer functions that record the arrival time and observed energy of
each flux element \citep{reynolds_x-ray_1999}. Two example transfer functions are shown in Figure
\ref{fig:lag-frequency-transfer-functions}. By convention the
origin of the time axis is set to the (mean) arrival time of the continuum
emission. We disambiguate these transfer functions from others by referring to
them as the \textit{lag transfer functions}. They are calculated by re-binning
image planes after ray-tracing the relevant quantities. We devised a method for
calculating the lag transfer functions using the Cunningham transfer functions,
described in \ref{sec:transfer-function-integration}. In this section, we verify
our methods by comparing with results in the literature.

% The lag transfer functions depend on the choice of observer inclination,
% spacetime, coronal model, and disc model. The inclination of the observer is
% sensitive to gravitational lensing effects as well as influencing the relative
% distances of different regions of the disc and corona, affecting the arrival
% times of emission. The spacetime changes both the light travel time close to the
% central singularity and the gravitational redshift. The spacetime is therefore
% imprinted in both the energy and arrival time of each flux element.  The coronal
% model, in its geometry and spectra, modifies the emissivity profile of the
% accretion disc (which in turns changes the flux element coming from each disc
% element). The coronal geometry may also change the arrival time of both the
% continuum and reflected emissions. The disc geometry contributes to all of the
% above.

% \citep{reynolds_x-ray_1999,wilkins_origin_2013,cackett_modelling_2014}

\begin{figure}
    \centering
    \includegraphics[width=0.97\linewidth]{figures/transfer-functions.2d.pdf}
    \caption{Two-dimensional transfer functions for the maximally spinning Kerr
    spacetime ($a = 0.998$) for two different observer inclinations. These are
    calculated by integrating the time-dependent transfer functions (details in
the text).}
    \label{fig:lag-frequency-transfer-functions}
\end{figure}

\subsubsection{Lag-frequency spectra}

% and allows us to construct high resolution lag transfer functions of
% \cite{reynolds_x-ray_1999} with little additional computational time (see
% Section \ref{sec:lag-transfer-functions}).

Summing the lag transfer functions (Figure
\ref{fig:lag-frequency-transfer-functions}) over the energy axis for a given
energy range yields an \textit{impulse response function} $\psi(t)$, which
encodes how the disc responds to the impulse of a coronal flash.
% This impulse
% response depends on the properties of the illuminating corona, accretion disc,
% spacetime, and inclination of the observer.
Examples for different lamppost
heights over the full energy range are shown in the top panel of Figure
\ref{fig:reverberation-thin}.

Following \cite{cackett_modelling_2014}, we define the \textit{response
fraction}, $R$, as the ratio of reflected to continuum flux. The impulse response
in the Fourier domain is the scaled Fourier transform
\begin{equation}
    \mathscr{F}_\psi(f) := R \int_{0}^\infty \psi(t) \e^{-2\pi i f t} \d t
\end{equation}
at frequency $f$.
The phase difference between the reflected and continuum flux is
\begin{equation}
    \phi(f) = \tan^{-1} \left(
        \frac{\Im{\mathscr{F}_\psi}}{1 + \Re{\mathscr{F}_\psi}}
    \right),
\end{equation}
where $\Im{\mathscr{F}_\psi}$ and $\Re{\mathscr{F}_\psi}$ are the imaginary and
real components of $\mathscr{F}_\psi$ respectively. The imaginary component
represents the lag contribution to the phase difference. Since the driving
signal is present in both bands, it adds no lag contribution, but serves to
dilute the phase difference and therefore the real component of the signal
through the $+1$ in the denominator.

A subtlety to address here in the normalisation of the impulse responses, as we
do not fully model the continuum spectrum. We assume, as in
\cite{cackett_modelling_2014}, that the reflected flux of the line is equal to
the continuum flux ($R = 1$). Therefore, we normalise the impulse response
functions by dividing by a factor $Q = \int \psi_{\text{Fe K}\alpha}(t)$, so
that the area under the line impulse response function is unity.


The time lag is defined as
\begin{equation}
    \tau(f) := \frac{\phi}{2 \pi f},
\end{equation}
and relates the observed time lag to the Fourier frequency of the driving
signal (lower panel of Figure \ref{fig:reverberation-thin}).  We find good
agreement with \cite{cackett_modelling_2014} for all cases.

\begin{figure}
    \centering
    \includegraphics[width=0.98\linewidth]{figures/reverberation.thin-disc.pdf}
    \caption{Impulse responses and lag-frequency spectra of a lamppost model in
        the Kerr spacetime ($a = 0.998$) for different heights of the lamppost
        model. The solid lines are the razor-thin disc case, whereas the dotted
        lines are for the Shakura-Sunyaev disc solution with $\dot{M} /
    \dot{M}_\text{Edd} = 0.3$. Panel a) shows the impulse responses summed
across all energy bands, and panel b) shows the corresponding lag-frequency
spectra of the impulse responses. }
    \label{fig:reverberation-thin}
\end{figure}


\subsubsection{Lag-energy spectra}

Lag-energy spectra show the time lag as a function of energy within specific frequency bands $f + \Delta
f$. Since we have mandated for consistency with \cite{cackett_modelling_2014}
that the reflected flux of the \FeKa line is equal to the continuum flux,
the reference energy band is $E/E_\text{em} = 1$.  For the impulse response of
each energy channel (rows in the lag transfer functions), the lag-frequency
spectrum is calculated. The mean lag within $f + \Delta f$ is determined, and
plotted as a function of energy. Figure \ref{fig:lag-energy} shows
the time lag as a function of energy relative to the \FeKa band,
to be compared to Figure 11 in \cite{cackett_modelling_2014}. As with the
lag-frequency spectra, we attribute the differences in the low frequency band to
the weak field approximation employed by the other authors, which results in a
larger low frequency lag.

\begin{figure}
    \centering
    \includegraphics[width=0.98\linewidth]{figures/reverberation.lag-energy.pdf}
    \caption{Lag-energy spectra for the same setup as in Figure
    \ref{fig:reverberation-thin} but only for case where the lamppost height is
$h=10$. The different colours now correspond to the frequency bands used to
calculate the lag-energy spectrum (shown in the inset panel). The solid lines,
as before, denote the razor thin disc, whereas the dotted lines are the
Shakura-Sunyaev disc with $\dot{M} / \dot{M}_\text{Edd} =0.3$.}
    \label{fig:lag-energy}
\end{figure}


\subsection{Radiative transfer}

\begin{figure*}
    \centering
    \includegraphics[width=0.99\linewidth]{figures/radiative-transfer.gold.pdf}
    \caption{Intensity images calculated with \Gradus of the radiative transfer analytic test models specified in \citet{gold_verification_2020} with resolution $128 \times 128$ pixels, and impact parameters ranging between $-15\, \rg$ and $15\, \rg$, and observer position $r_\text{obs} = 1000\, \rg$ and inclination $\theta_\text{obs} = 60^\circ$. The test cases correspond to the test parameters in their Table 1. The colouring is the intensity for the geodesic corresponding to that pixel normalized over the total intensity .}
    \label{fig:gold-test-problems}
\end{figure*}

\cite{gold_verification_2020} specify an analytic model for testing radiative
transfer codes (their Section 3.2, with results shown in their Figure 2 and 3).
The model gives the emissivity and absorptivity coefficients of a (corotating)
fluid as a function of radial coordinate. There are five free parameters in this
specification that can be used to control the model, for which they give 5
standardized tests.

We have implemented their model and see very good agreement across all of the
tests, shown in Figure \ref{fig:gold-test-problems}. Our covariant radiative
transfer implementation therefore reproduces the same results as other GRRT
codes to within standard tolerances.

\subsection{Other spacetimes}

Reflection and reverberation features have been explored beyond the Kerr
spacetime as a means of study the ``no-hair theorem'' \citep[for a review,
see][]{bambi_testing_2022}. To test our implementation, we compare the line
profiles calculated with \Gradus to those calculated in
\citet{johannsen_testing_2010}. Our lineprofiles, calculated via Cunningham
transfer function integration, are shown in Figure
\ref{fig:reflection-johannsen}. We find excellent agreement with the published
line profiles in \citet{johannsen_testing_2010}. We demonstrate the flexibilty
of the code by implementing the Einstein-Maxwell-Dilaton-Axion metric derived
in \citet{garcia_class_1995} and calculate lineprofiles for various values of
the $b$ constant, shown in Figure \ref{fig:reflection-emda}.

\begin{figure}
    \centering
    \includegraphics[width=0.99\linewidth]{figures/lineprofiles.johannsen-comparison.pdf}
    \caption{\todo{caption}}
    \label{fig:reflection-johannsen}
\end{figure}

As a demonstration of the capabilities of \Gradus, we also compute sample
line profiles for the Einstein-Maxwell-Axion-Dilaton spacetime.

\begin{figure}
    \centering
    \includegraphics[width=0.99\linewidth]{figures/lineprofile.emda.pdf}
    \caption{\todo{caption}}
    \label{fig:reflection-emda}
\end{figure}

\section{Application to thick discs reverberation lags}
\label{sec:applications}

Our thick disc transfer function calculation method described in Section
\ref{sec:partially-obscured-functions} allows spectra for arbitrary disc
geometries to be efficiently computed. We demonstrate this by calculating high
resolution lag-energy spectra for the SSD, with self-consistent emissivity and
light-crossing profiles for the lamppost model, similar to
\citet{taylor_x-ray_2018_reverb}. The results are shown in Figure
\ref{fig:reverb-thick-discs} for different Eddington accretion rates. The
self-obscuration of the disc has here the same effect as in the line profiles.
As the inclination steepens towards the plane of the disc, the highest blue
shifted component moves to lower energies due to obscuration. In tandem with
this is a decrease in the time lag relative to the thin disc case, which is
comparable to the thickness of the disc. At lower inclinations, the effect of
the disc thickness is negligible.

In Figure \ref{fig:reverb-thick-discs-corona}, the lamppost height is changed
for a fixed Eddington ratio. For low coronal heights, the thickness of the disc
has a significant impact on the emissivity and light-crossing profiles, which
therefore distorts the observed lag-energy profile across all inclinations and
Fourier frequencies. Distant regions of the accretion disc have their
contributions to the observed reflection flux suppressed, as the corona is
obscured by the disc. Due to its proximity to the central singularity, the
light travel time is compounded over the height of the disc, resulting in
dramatically decreased lags. The effect of lamppost height is pronounced, and can
significantly change the shape of the lag-energy profile.

\begin{figure*}
    \centering
    \includegraphics[width=0.99\linewidth]{figures/reverberation.thick-disc.pdf}
    \caption{Lag-energy profiles for the SSD, using the same colour scheme as in
        Figure \ref{fig:lag-energy}. For all figures the Kerr spacetime
        ($a=0.998$) is used with a lamppost corona, $h = 10 \rg$. The light grey
        lines show the corresponding razor-thin disc lag-energy profiles. The
        columns show the effect of changing the Eddington ratio $\dot{M} /
        \dot{M}_\text{Edd}$, and the rows are changing the inclination. When
        $\theta \lesssim 40^\circ$, the differences between the thin disc and
        the SSD are minimal when the lamppost corona is at an appreciable height
        above the black hole.}
    \label{fig:reverb-thick-discs}
\end{figure*}

\begin{figure*}
    \centering
    \includegraphics[width=0.99\linewidth]{figures/reverberation.thick-disc-corona.pdf}
    \caption{As in Figure \ref{fig:reverb-thick-discs}, except the Eddington
        ratio is now fixed to $0.3$, and instead the lamppost corona height is
        varied. When the height of the corona is low, there is significant
        obscuration leading to increased emissivity at low radii, and reduced
        emissivity at distant radii, and similarly with the light crossing
    times. This makes a marked change irrespective of inclination, but only
occurs when the coronal height is comparable to the height of the disc.}
    \label{fig:reverb-thick-discs-corona}
\end{figure*}

\section{Conclusions}
\label{sec:conclusion}

\Gradus is new open-source and publicly available general relativistic
ray-tracing software that can be used in a variety of X-ray spectral modelling.
The software is able to reproduce results from other simulation works for a
variety of test problems related to stability and numerical accuracy. We have
demonstrated novel methods within \Gradus for calculating high resolution
reverberation lags efficiently for thick accretion discs using the Cunningham
transfer function formalism.

The software can be used to compute the transfer functions for a wide variety of
models. New spectral models for new assumptions or model component can be
rapidly developed, and the implementations are designed for users to be able to
construct their own simulations with ease.

Immediate applications that we are working on with \Gradus are for fitting the
disc thickness as a free parameter, iterating on work by \todo{jiachen's paper}.
We have also developed a method for rapidly computing reflection and
reverberation signatures from geometrically extended coronal models \todo{cite
in prep}. Future work on the software will extend the ray-tracing capabilities
to include polarisation transport, which we can efficiently pre-compute using
the same Cunningham transfer function approach as used for timing and
reverberation lags presented in this work.

We encourage the community to contact us with interesting problems that may be
tackled using \Gradus as we are happy to assist with new applications of the
code.

\section*{Acknowledgements}
This work is supported by the UKRI AIMLAC CDT funded by grant EP/S023992/1.

We thank Jiachen Jiang, Cosimo Bambi and Askar Abdikamalov for sharing their
software for comparisons, and thank Corbin Taylor for making the
\texttt{fenrir} code, along with many example scripts, public at our request. FB thanks Rosie for her expert debugging assistance. All figures created using Makie.jl \citep{DanischKrumbiegel2021}, using the color scheme of \cite{wong_points_2011}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{Data Availability}

No new data or analyses have been created for this work. The code to reproduce
this paper and all figures therein is freely available under GPL 3.0 license:
\url{https://github.com/fjebaker/gradus-paper}


% The inclusion of a Data Availability Statement is a requirement for articles published in MNRAS. Data Availability Statements provide a standardised format for readers to understand the availability of data underlying the research results described in the article. The statement may refer to original data generated in the course of the study or to third-party data analysed in the article. The statement should describe and provide means of access, where possible, by linking to the data or providing the required accession numbers for the relevant databases or DOIs.

%%%%%%%%%%%%%%%%%%%% REFERENCES %%%%%%%%%%%%%%%%%%

% The best way to enter references is to use BibTeX:

\bibliographystyle{mnras}
\bibliography{citations} % if your bibtex file is called example.bib


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% APPENDICES %%%%%%%%%%%%%%%%%%%%%

\appendix

\input{gradus.appendix.gram-schmidt.tex}
\input{gradus.appendix.circular-orbits.tex}
% \input{gradus.appendix.deflection-angle.tex}
% \input{gradus.appendix.integrator-error.tex}
% \input{gradus.appendix.continuum-time.tex}
% \input{gradus.appendix.hamiltonian-formalism.tex}

% \section{Some extra material}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% Don't change these lines
\bsp    % typesetting comment
\label{lastpage}
\end{document}

% End of mnras_template.tex
